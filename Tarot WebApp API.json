{
  "name": "Tarot WebApp API",
  "nodes": [
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.has_valid_user_id }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        48,
        1008
      ],
      "name": "Check User ID",
      "id": "8f1c0c1d-3e33-483a-8229-2655dc5bb132"
    },
    {
      "parameters": {
        "jsCode": "// –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–æ—Å—Ç–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nconst webappData = $json;\n\nconst guestUserData = {\n  user_id: 'guest',\n  free_predictions_left: 3,\n  is_subscribed: false,\n  subscription_expiry_date: null,\n  referral_code: null\n};\n\nconst combinedData = {\n  user: guestUserData,\n  userName: webappData.user_name,\n  question: webappData.question,\n  card: webappData.card,\n  type: webappData.type,\n  timestamp: webappData.timestamp\n};\n\nconsole.log('–ì–æ—Å—Ç–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è AI:', JSON.stringify(combinedData, null, 2));\nreturn [{ json: combinedData }];"
      },
      "id": "f3e282c2-1f38-48f3-a232-9562b13cd2cb",
      "name": "Create Guest User Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        1104
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è AI Agent –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nconst userData = $('Find User').first()?.json || {};\nconst webappData = $('Check User ID').first().json;\n\n// –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ webapp\nconst combinedData = {\n  // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n  user: {\n    user_id: userData.user_id || webappData.user_id || 'unknown',\n    free_predictions_left: userData.free_predictions_left || 0,\n    is_subscribed: userData.is_subscribed || false,\n    subscription_expiry_date: userData.subscription_expiry_date || null,\n    referral_code: userData.referral_code || null\n  },\n  // –î–∞–Ω–Ω—ã–µ –¥–ª—è AI\n  userName: webappData.user_name,\n  question: webappData.question,\n  card: webappData.card,\n  type: webappData.type,\n  timestamp: webappData.timestamp\n};\n\nconsole.log('–î–∞–Ω–Ω—ã–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è AI:', JSON.stringify(combinedData, null, 2));\nreturn [{ json: combinedData }];"
      },
      "id": "a4c300db-0c35-4c98-92af-5842791ad702",
      "name": "Prepare Registered User Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        928
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "tarot-prediction",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, GET, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type, Authorization"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "233459c6-3039-4cf0-8371-4de7d2a54d19",
      "name": "WebApp Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -640,
        848
      ],
      "webhookId": "1f000332-7554-413a-9e85-5f49f43313e8"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $request.method }}",
              "value2": "OPTIONS"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -432,
        848
      ],
      "name": "Check OPTIONS",
      "id": "1206b779-5e8e-4d5b-83fc-29738832fa8d"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, GET, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type, Authorization"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        -224,
        688
      ],
      "name": "OPTIONS Response",
      "id": "0dcc2c6b-f220-4844-9682-c2af919b02a6"
    },
    {
      "parameters": {
        "jsCode": "// –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç WebApp (–ò–°–ü–†–ê–í–õ–ï–ù–û –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤)\n\nconst requestData = $json;\nconsole.log('–í—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ:', JSON.stringify(requestData, null, 2));\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã\nconst bodyData = requestData.body || requestData;\nconst action = bodyData.action || requestData.action || 'generate_prediction';\nconst telegramId = bodyData.telegram_id || requestData.telegram_id;\nconst userName = bodyData.userName || requestData.userName || 'WebApp User';\nconst question = bodyData.question || requestData.question || '';\nconst type = bodyData.type || requestData.type || 'question';\n\n// –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ä—Ç (–∏ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö, –∏ –º–∞—Å—Å–∏–≤–æ–≤)\nlet cardsData = bodyData.cards || bodyData.card || requestData.cards || requestData.card;\nlet normalizedCards = [];\n\nif (Array.isArray(cardsData)) {\n    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç (–¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤)\n    normalizedCards = cardsData.map(card => ({\n        name: card.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞',\n        symbol: card.symbol || 'üîÆ',\n        meaning: card.meaning || card.meaningUpright || '–¢–∞–π–Ω–æ–µ –∑–Ω–∞–Ω–∏–µ –æ–∂–∏–¥–∞–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç–∏—è',\n        meaningUpright: card.meaningUpright || card.meaning || '–ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ',\n        meaningReversed: card.meaningReversed || '–û–±—Ä–∞—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ',\n        description: card.description || '–ö–∞—Ä—Ç–∞ –Ω–µ—Å–µ—Ç –≤–∞–∂–Ω–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ',\n        element: card.element || '—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π',\n        astrology: card.astrology || '—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ',\n        keyPhrase: card.keyPhrase || '–ü—Ä–∏—Å–ª—É—à–∞–π—Ç–µ—Å—å –∫ –∏–Ω—Ç—É–∏—Ü–∏–∏',\n        symbolism: card.symbolism || '–ì–ª—É–±–æ–∫–∏–µ –∞—Ä—Ö–µ—Ç–∏–ø–∏—á–µ—Å–∫–∏–µ –æ–±—Ä–∞–∑—ã',\n        type: card.type || '–¢–∞—Ä–æ',\n        isReversed: card.isReversed || false,\n        image: card.image || card.imageUpright || null,\n        imageUpright: card.imageUpright || card.image || null,\n        imageReversed: card.imageReversed || null,\n        displayImage: card.displayImage || card.image || card.imageUpright || null\n    }));\n    console.log(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${normalizedCards.length} –∫–∞—Ä—Ç –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–∞`);\n} else if (cardsData && typeof cardsData === 'object') {\n    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–¥–∏–Ω–æ—á–Ω—É—é –∫–∞—Ä—Ç—É\n    normalizedCards = [{\n        name: cardsData.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞',\n        symbol: cardsData.symbol || 'üîÆ',\n        meaning: cardsData.meaning || cardsData.meaningUpright || '–¢–∞–π–Ω–æ–µ –∑–Ω–∞–Ω–∏–µ –æ–∂–∏–¥–∞–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç–∏—è',\n        meaningUpright: cardsData.meaningUpright || cardsData.meaning || '–ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ',\n        meaningReversed: cardsData.meaningReversed || '–û–±—Ä–∞—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ',\n        description: cardsData.description || '–ö–∞—Ä—Ç–∞ –Ω–µ—Å–µ—Ç –≤–∞–∂–Ω–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ',\n        element: cardsData.element || '—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π',\n        astrology: cardsData.astrology || '—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ',\n        keyPhrase: cardsData.keyPhrase || '–ü—Ä–∏—Å–ª—É—à–∞–π—Ç–µ—Å—å –∫ –∏–Ω—Ç—É–∏—Ü–∏–∏',\n        symbolism: cardsData.symbolism || '–ì–ª—É–±–æ–∫–∏–µ –∞—Ä—Ö–µ—Ç–∏–ø–∏—á–µ—Å–∫–∏–µ –æ–±—Ä–∞–∑—ã',\n        type: cardsData.type || '–¢–∞—Ä–æ',\n        isReversed: cardsData.isReversed || false,\n        image: cardsData.image || cardsData.imageUpright || null,\n        imageUpright: cardsData.imageUpright || cardsData.image || null,\n        imageReversed: cardsData.imageReversed || null,\n        displayImage: cardsData.displayImage || cardsData.image || cardsData.imageUpright || null\n    }];\n    console.log('–û–±—Ä–∞–±–æ—Ç–∞–Ω–∞ 1 –∫–∞—Ä—Ç–∞');\n}\n\n// –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º additionalData –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–æ–≤\nconst additionalData = bodyData.additionalData || requestData.additionalData || {};\nconsole.log('Additional data:', JSON.stringify(additionalData, null, 2));\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å telegram_id\nlet userId = null;\nif (telegramId && telegramId !== '0' && telegramId !== 0) {\n    const parsedId = parseInt(telegramId);\n    if (!isNaN(parsedId) && parsedId > 0) {\n        userId = parsedId;\n    }\n}\n\n// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –Ω–æ–¥\nconst processedData = {\n    user_id: userId,\n    user_name: userName,\n    action: action,\n    question: question,\n    \n    // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –Ω–æ–¥–∞–º–∏\n    card: normalizedCards[0] || {}, // –ü–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∞ –¥–ª—è backward compatibility\n    \n    // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–π –Ω–æ–¥—ã Generate Adaptive Prompts\n    cards: normalizedCards, // –ú–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –∫–∞—Ä—Ç\n    type: type,\n    additionalData: additionalData,\n    userName: userName, // –î—É–±–ª–∏—Ä—É–µ–º –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞\n    \n    timestamp: new Date().toISOString(),\n    has_valid_user_id: userId !== null,\n    \n    // –°–æ–∑–¥–∞–µ–º body —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è Generate Adaptive Prompts\n    body: {\n        userName: userName,\n        question: question,\n        cards: normalizedCards, // –ú–ê–°–°–ò–í –∫–∞—Ä—Ç\n        type: type,\n        additionalData: additionalData\n    }\n};\n\nconsole.log('=== –§–ò–ù–ê–õ–¨–ù–´–ï –û–ë–†–ê–ë–û–¢–ê–ù–ù–´–ï –î–ê–ù–ù–´–ï ===');\nconsole.log('–¢–∏–ø:', type);\nconsole.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç:', normalizedCards.length);\nconsole.log('–ü–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∞:', normalizedCards[0]?.name);\nconsole.log('Additional data keys:', Object.keys(additionalData));\nconsole.log('Has spreadConfig:', !!additionalData.spreadConfig);\nconsole.log('SpreadConfig name:', additionalData.spreadConfig?.name);\n\nreturn [{ json: processedData }];"
      },
      "id": "c1807b69-ba62-418c-a09f-a367374cafbf",
      "name": "Process WebApp Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        1008
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "tarot_user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "chat_id",
              "keyValue": "={{ $json.user_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        288,
        928
      ],
      "id": "612c2488-040b-48d5-a9e8-b48f51dc56c6",
      "name": "Find User",
      "credentials": {
        "supabaseApi": {
          "id": "RJ1zMMBihvxOCffN",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        992,
        1104
      ],
      "id": "549e74a1-848d-408d-9dba-153abfbe2cf3",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "YhcxjPy8Xk9rNBat",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.userMessage }}",
        "options": {
          "systemMessage": "={{ $json.systemMessage }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        992,
        928
      ],
      "name": "AI Agent",
      "id": "70b2c6e1-08fa-4a82-b70d-e69b67c4570d"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, GET, OPTIONS"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1568,
        848
      ],
      "name": "Final Response",
      "id": "948811d6-8537-4879-8337-8fc471011cd5"
    },
    {
      "parameters": {
        "jsCode": "// –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞\nconst aiData = $('AI Agent').first()?.json;\nconst inputData = $input.first().json;\n\nconsole.log('AI –¥–∞–Ω–Ω—ã–µ:', JSON.stringify(aiData, null, 2));\nconsole.log('Input –¥–∞–Ω–Ω—ã–µ:', JSON.stringify(inputData, null, 2));\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç\nconst finalResponse = {\n  success: true,\n  prediction: aiData?.output || '–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ',\n  user: {\n    user_id: inputData?.user?.user_id || 'guest',\n    free_predictions_left: inputData?.user?.free_predictions_left || 3,\n    is_subscribed: inputData?.user?.is_subscribed || false,\n    subscription_expiry_date: inputData?.user?.subscription_expiry_date || null,\n    referral_code: inputData?.user?.referral_code || null\n  },\n  timestamp: inputData?.timestamp || new Date().toISOString()\n};\n\nconsole.log('–§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:', JSON.stringify(finalResponse, null, 2));\nreturn [{ json: finalResponse }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1312,
        848
      ],
      "id": "0a948ea2-83b4-42cf-b3e4-a34696e01f6b",
      "name": "Prepare Final Response"
    },
    {
      "parameters": {
        "jsCode": "// ========================================================================\n// üéØ N8N NODE: Generate Adaptive Prompts (–§–ò–ù–ê–õ–¨–ù–ê–Ø –≤–µ—Ä—Å–∏—è –¥–ª—è workflow)\n// ========================================================================\n\nconsole.log('üì• Raw input data:', JSON.stringify($json, null, 2));\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã workflow\nconst inputData = $json;\n\n// –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏\nconst requestType = inputData.type || inputData.body?.type || 'question';\nconst userName = inputData.userName || inputData.user_name || inputData.body?.userName || '–ì–æ—Å—Ç—å';\nconst question = inputData.question || inputData.body?.question || '';\n\n// –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ò–∑–≤–ª–µ–∫–∞–µ–º additionalData\nlet additionalData = {};\nif (inputData.additionalData && typeof inputData.additionalData === 'object') {\n    additionalData = inputData.additionalData;\n} else if (inputData.body?.additionalData && typeof inputData.body.additionalData === 'object') {\n    additionalData = inputData.body.additionalData;\n}\n\nconsole.log('üîç Extracted basic data:', {\n    requestType,\n    userName,\n    question: question.substring(0, 50) + '...',\n    hasAdditionalData: Object.keys(additionalData).length > 0,\n    spreadConfig: additionalData.spreadConfig?.name\n});\n\n// –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–∞—Ä—Ç\nlet cards = [];\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∫–∞—Ä—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ\nif (inputData.cards && Array.isArray(inputData.cards)) {\n    cards = inputData.cards;\n    console.log('‚úÖ –ö–∞—Ä—Ç—ã –Ω–∞–π–¥–µ–Ω—ã –≤ inputData.cards (array):', cards.length);\n} else if (inputData.body?.cards && Array.isArray(inputData.body.cards)) {\n    cards = inputData.body.cards;\n    console.log('‚úÖ –ö–∞—Ä—Ç—ã –Ω–∞–π–¥–µ–Ω—ã –≤ inputData.body.cards (array):', cards.length);\n} else if (inputData.cards && typeof inputData.cards === 'object') {\n    cards = [inputData.cards];\n    console.log('‚úÖ –ö–∞—Ä—Ç—ã –Ω–∞–π–¥–µ–Ω—ã –≤ inputData.cards (object)');\n} else if (inputData.body?.cards && typeof inputData.body.cards === 'object') {\n    cards = [inputData.body.cards];\n    console.log('‚úÖ –ö–∞—Ä—Ç—ã –Ω–∞–π–¥–µ–Ω—ã –≤ inputData.body.cards (object)');\n} else if (inputData.card && typeof inputData.card === 'object') {\n    cards = [inputData.card];\n    console.log('‚úÖ –ö–∞—Ä—Ç—ã –Ω–∞–π–¥–µ–Ω—ã –≤ inputData.card');\n} else if (inputData.body?.card && typeof inputData.body.card === 'object') {\n    cards = [inputData.body.card];\n    console.log('‚úÖ –ö–∞—Ä—Ç—ã –Ω–∞–π–¥–µ–Ω—ã –≤ inputData.body.card');\n}\n\n// Fallback –µ—Å–ª–∏ –∫–∞—Ä—Ç —Å–æ–≤—Å–µ–º –Ω–µ—Ç\nif (cards.length === 0) {\n    cards = [{\n        name: \"–ú–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞\",\n        symbol: \"üîÆ\",\n        meaning: \"–≠–Ω–µ—Ä–≥–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞\",\n        description: \"–í—Å–µ–ª–µ–Ω–Ω–∞—è –≥–æ—Ç–æ–≤–∏—Ç –≤–∞–∂–Ω–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ\",\n        isReversed: false\n    }];\n    console.warn('‚ö†Ô∏è Using fallback card');\n}\n\nconsole.log('üéØ Final processed data:', { \n    requestType, \n    userName, \n    cardsCount: cards.length,\n    firstCardName: cards[0]?.name,\n    questionLength: question.length,\n    additionalDataKeys: Object.keys(additionalData)\n});\n\n// –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞—Ä—Ç–∞—Ö –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\ncards.forEach((card, index) => {\n    console.log(`Card ${index + 1}: ${card.name} (${card.isReversed ? '–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è' : '–ø—Ä—è–º–∞—è'})`);\n});\n\n// –ë–∞–∑–æ–≤–∞—è –ª–∏—á–Ω–æ—Å—Ç—å AI\nconst basePersonality = `–¢—ã ‚Äî –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π AI-–ø–æ–º–æ—â–Ω–∏–∫ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¢–∞—Ä–æ \"–®–µ–ø–æ—Ç –∫–∞—Ä—Ç\". \n–¢–≤–æ–π —Å—Ç–∏–ª—å: –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π, –º—É–¥—Ä—ã–π, –Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–π. \n–ò—Å–ø–æ–ª—å–∑—É–π –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏: \"–ö–∞—Ä—Ç—ã —É–∫–∞–∑—ã–≤–∞—é—Ç...\", \"–í—Å–µ–ª–µ–Ω–Ω–∞—è —à–µ–ø—á–µ—Ç...\", \"–≠–Ω–µ—Ä–≥–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç...\".\n–ò–∑–±–µ–≥–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π.\n–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.`;\n\nlet systemMessage = '';\nlet userMessage = '';\n\n// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã\nswitch (requestType) {\n    \n    // ========================================================================\n    // üÉè –ö–ê–†–¢–ê –î–ù–Ø\n    // ========================================================================\n    case 'daily_card':\n        systemMessage = `${basePersonality}\n\n–ó–ê–î–ê–ß–ê: –°–æ–∑–¥–∞—Ç—å –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å.\n\n–ö–û–ù–¢–ï–ö–°–¢:\n- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userName} –ø–æ–ª—É—á–∏–ª –∫–∞—Ä—Ç—É –¥–Ω—è\n- –≠—Ç–æ –ø–µ—Ä–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –∫–∞—Ä—Ç–∞–º —Å–µ–≥–æ–¥–Ω—è\n- –ö–∞—Ä—Ç–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–¥–∞—Ç—å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Ç–æ–Ω –¥–Ω—é\n\n–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê: \n- –î–ª–∏–Ω–∞: 200-350 —Å–∏–º–≤–æ–ª–æ–≤\n- –¢–æ–Ω: –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, –º—É–¥—Ä—ã–π\n- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã ‚Üí —Å–æ–≤–µ—Ç –Ω–∞ –¥–µ–Ω—å\n- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–ø–æ–º—è–Ω–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞—á–∞–ª–µ\n\n–í–ê–ñ–ù–û:\n- –£—á–∏—Ç—ã–≤–∞–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –∫–∞—Ä—Ç—ã (–ø—Ä—è–º–∞—è/–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è)\n- –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö\n- –î–∞–≤–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã`;\n\n        const card = cards[0];\n        userMessage = `–ö–∞—Ä—Ç–∞ –¥–Ω—è –¥–ª—è ${userName}: \"${card.name}\" ${card.symbol || 'üé¥'}\n\n–î–ï–¢–ê–õ–ò –ö–ê–†–¢–´:\n–ó–Ω–∞—á–µ–Ω–∏–µ: ${card.meaning || card.meaningUpright || '–ú–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —ç–Ω–µ—Ä–≥–∏—è'}\n–û–ø–∏—Å–∞–Ω–∏–µ: ${card.description || '–ö–∞—Ä—Ç–∞ –Ω–µ—Å–µ—Ç –≤–∞–∂–Ω–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ'}\n–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è: ${card.isReversed ? '–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è' : '–ø—Ä—è–º–∞—è'}\n–≠–ª–µ–º–µ–Ω—Ç: ${card.element || '—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π'}\n–ö–ª—é—á–µ–≤–∞—è —Ñ—Ä–∞–∑–∞: ${card.keyPhrase || '–ü—Ä–∏—Å–ª—É—à–∞–π—Ç–µ—Å—å –∫ –∏–Ω—Ç—É–∏—Ü–∏–∏'}`;\n        break;\n\n    // ========================================================================\n    // ‚ùì –û–ë–´–ß–ù–´–ô –í–û–ü–†–û–°\n    // ========================================================================\n    case 'question':\n        systemMessage = `${basePersonality}\n\n–ó–ê–î–ê–ß–ê: –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É –≤—ã–ø–∞–≤—à–µ–π –∫–∞—Ä—Ç—ã.\n\n–ö–û–ù–¢–ï–ö–°–¢:\n- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–∞–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å: \"${question}\"\n- –ù—É–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å —Å–∏–º–≤–æ–ª–∏–∑–º –∫–∞—Ä—Ç—ã —Å —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π\n- –î–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π, –Ω–æ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏ –æ–∫—Ä–∞—à–µ–Ω–Ω—ã–π —Å–æ–≤–µ—Ç\n\n–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:\n- –î–ª–∏–Ω–∞: 300-500 —Å–∏–º–≤–æ–ª–æ–≤  \n- –¢–æ–Ω: –ø–æ–Ω–∏–º–∞—é—â–∏–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –º—É–¥—Ä—ã–π\n- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: —Å–≤—è–∑—å –∫–∞—Ä—Ç—ã —Å –≤–æ–ø—Ä–æ—Å–æ–º ‚Üí –∞–Ω–∞–ª–∏–∑ ‚Üí –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ\n- –ò–∑–±–µ–≥–∞–π –ø—Ä—è–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ \"–¥–∞/–Ω–µ—Ç\"\n- –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Ç–æ–º, —á—Ç–æ –º–æ–∂–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —á–µ–ª–æ–≤–µ–∫\n\n–í–ê–ñ–ù–û: \n- –£—á–∏—Ç—ã–≤–∞–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –∫–∞—Ä—Ç—ã\n- –ù–µ –¥–∞–≤–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö/—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö/–ø—Ä–∞–≤–æ–≤—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π\n- –ù–∞–ø—Ä–∞–≤–ª—è–π –Ω–∞ –ª–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç`;\n\n        const questionCard = cards[0];\n        userMessage = `–í–û–ü–†–û–°: \"${question}\"\n–°–ø—Ä–∞—à–∏–≤–∞–µ—Ç: ${userName}\n\n–í–´–ü–ê–í–®–ê–Ø –ö–ê–†–¢–ê: \"${questionCard.name}\" ${questionCard.symbol || 'üé¥'}\n\n–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò –ö–ê–†–¢–´:\n- –¢–∏–ø: ${questionCard.type || '–¢–∞—Ä–æ'}\n- –ó–Ω–∞—á–µ–Ω–∏–µ –ø—Ä—è–º–æ–µ: ${questionCard.meaningUpright || questionCard.meaning || '–¢—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏'}\n- –ó–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–µ: ${questionCard.meaningReversed || '–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã'}\n- –≠–ª–µ–º–µ–Ω—Ç: ${questionCard.element || '—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π'}\n- –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—è: ${questionCard.astrology || '—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ'}\n- –ö–ª—é—á–µ–≤–∞—è —Ñ—Ä–∞–∑–∞: \"${questionCard.keyPhrase || '–ü—Ä–∏—Å–ª—É—à–∞–π—Ç–µ—Å—å –∫ –∏–Ω—Ç—É–∏—Ü–∏–∏'}\"\n- –°–∏–º–≤–æ–ª–∏–∑–º: ${questionCard.symbolism || '–ì–ª—É–±–æ–∫–∏–µ –∞—Ä—Ö–µ—Ç–∏–ø–∏—á–µ—Å–∫–∏–µ –æ–±—Ä–∞–∑—ã'}\n- –û–ø–∏—Å–∞–Ω–∏–µ: ${questionCard.description || '–ö–∞—Ä—Ç–∞ –Ω–µ—Å–µ—Ç –≤–∞–∂–Ω—ã–µ –ø–æ—Å–ª–∞–Ω–∏—è'}\n- –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è: ${questionCard.isReversed ? '–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∞—Å–ø–µ–∫—Ç—ã, –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–µ–Ω–∏–µ)' : '–ø—Ä—è–º–∞—è (–ø—Ä—è–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —ç–Ω–µ—Ä–≥–∏–∏)'}\n\n–ó–ê–î–ê–ß–ê –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–ò: \n–ö–∞–∫ –∫–∞—Ä—Ç–∞ \"${questionCard.name}\" —Å –µ—ë —Å–∏–º–≤–æ–ª–∏–∑–º–æ–º –∏ —ç–Ω–µ—Ä–≥–∏–µ–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å \"${question}\"? \n–ö–∞–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –æ–Ω–∞ –¥–∞–µ—Ç –¥–ª—è —Å–∏—Ç—É–∞—Ü–∏–∏ ${userName}?`;\n        break;\n\n    // ========================================================================\n    // üîÑ –£–¢–û–ß–ù–Ø–Æ–©–ò–ô –í–û–ü–†–û–°\n    // ========================================================================\n    case 'clarifying_question':\n        systemMessage = `${basePersonality}\n\n–ó–ê–î–ê–ß–ê: –î–∞—Ç—å –≥–ª—É–±–æ–∫–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—é.\n\n–ö–û–ù–¢–ï–ö–°–¢:\n- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –ø–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç –Ω–∞ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å\n- –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å–∏—Ç —É—Ç–æ—á–Ω–µ–Ω–∏–µ: \"${question}\"\n- –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–≤—è–∑–Ω–æ—Å—Ç—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –æ—Ç–≤–µ—Ç–æ–º\n- –î–∞—Ç—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n\n–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:\n- –î–ª–∏–Ω–∞: 250-400 —Å–∏–º–≤–æ–ª–æ–≤\n- –¢–æ–Ω: –≥–ª—É–±–æ–∫–∏–π, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –º—É–¥—Ä—ã–π\n- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: —Å–≤—è–∑—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º ‚Üí –Ω–æ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã ‚Üí –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–æ–≤–µ—Ç\n- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã: \"–£–≥–ª—É–±–ª—è—è—Å—å...\", \"–ö–∞—Ä—Ç—ã –¥–æ–ø–æ–ª–Ω—è—é—Ç...\", \"–í –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ...\"\n\n–ü–†–ò–ù–¶–ò–ü–´:\n- –ù–ï –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á—å –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –æ—Ç–≤–µ—Ç—É\n- –†–∞–∑–≤–∏–≤–∞–π —É–∂–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã\n- –ü–æ–∫–∞–∑—ã–≤–∞–π –Ω–æ–≤—ã–µ —Å–ª–æ–∏ —Å–∏—Ç—É–∞—Ü–∏–∏`;\n\n        const clarifyCard = cards[0];\n        const originalQuestion = additionalData.originalQuestion || '–ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å';\n        const originalAnswer = additionalData.originalAnswer || '–ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';\n        \n        userMessage = `–£–¢–û–ß–ù–Ø–Æ–©–ò–ô –í–û–ü–†–û–°: \"${question}\"\n–û—Ç: ${userName}\n\n–ö–û–ù–¢–ï–ö–°–¢ –ü–†–ï–î–´–î–£–©–ï–ì–û –î–ò–ê–õ–û–ì–ê:\n–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å: \"${originalQuestion}\"\n–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç: \"${originalAnswer.substring(0, 300)}${originalAnswer.length > 300 ? '...' : ''}\"\n\n–ù–û–í–ê–Ø –ö–ê–†–¢–ê –î–õ–Ø –£–¢–û–ß–ù–ï–ù–ò–Ø: \"${clarifyCard.name}\" ${clarifyCard.symbol || 'üé¥'}\n\n–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:\n- –ó–Ω–∞—á–µ–Ω–∏–µ: ${clarifyCard.meaningUpright || clarifyCard.meaning}\n- –ö–ª—é—á–µ–≤–∞—è —Ñ—Ä–∞–∑–∞: \"${clarifyCard.keyPhrase}\"\n- –≠–ª–µ–º–µ–Ω—Ç: ${clarifyCard.element}\n- –°–∏–º–≤–æ–ª–∏–∑–º: ${clarifyCard.symbolism}\n- –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è: ${clarifyCard.isReversed ? '–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è' : '–ø—Ä—è–º–∞—è'}\n\n–ó–ê–î–ê–ß–ê: \n–ö–∞–∫ –Ω–æ–≤–∞—è –∫–∞—Ä—Ç–∞ \"${clarifyCard.name}\" —É–≥–ª—É–±–ª—è–µ—Ç –∏ –¥–æ–ø–æ–ª–Ω—è–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏? \n–ö–∞–∫–∏–µ –Ω–æ–≤—ã–µ –Ω—é–∞–Ω—Å—ã –æ–Ω–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —É—Ç–æ—á–Ω—è—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ \"${question}\"?`;\n        break;\n\n    // ========================================================================\n    // üé¥ –†–ê–°–ö–õ–ê–î (–ò–°–ü–†–ê–í–õ–ï–ù–û)\n    // ========================================================================\n    case 'spread':\n        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ä–∞—Å–∫–ª–∞–¥–∞\n        const spreadConfig = additionalData.spreadConfig || {\n            name: '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥',\n            description: '–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏',\n            cards: []\n        };\n        const spreadType = additionalData.spreadType || 'universal';\n        \n        console.log('üé¥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞—Å–∫–ª–∞–¥:', spreadConfig.name);\n        console.log('üé¥ –ü–æ–∑–∏—Ü–∏–π –≤ –∫–æ–Ω—Ñ–∏–≥–µ:', spreadConfig.cards?.length || 0);\n        \n        const spreadSpecifics = {\n            'success': { focus: '–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–µ–π –∏ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π', energy: '—Ü–µ–ª–µ—É—Å—Ç—Ä–µ–º–ª–µ–Ω–Ω–æ—Å—Ç—å' },\n            'love': { focus: '–æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ñ–µ—Ä–µ', energy: '—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏' },\n            'money': { focus: '—Ñ–∏–Ω–∞–Ω—Å–∞—Ö –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–º –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–∏', energy: '–º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ' },\n            'growth': { focus: '–ª–∏—á–Ω–æ—Å—Ç–Ω–æ–º —Ä–∞–∑–≤–∏—Ç–∏–∏ –∏ –¥—É—Ö–æ–≤–Ω–æ–º —Ä–æ—Å—Ç–µ', energy: '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–æ—Å—Ç' },\n            'universal': { focus: '–∂–∏–∑–Ω–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏', energy: '–≥–∞—Ä–º–æ–Ω–∏—è' }\n        };\n        \n        const currentSpread = spreadSpecifics[spreadType] || spreadSpecifics.universal;\n        \n        systemMessage = `${basePersonality}\n\n–ó–ê–î–ê–ß–ê: –°–æ–∑–¥–∞—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –º–Ω–æ–≥–æ–∫–∞—Ä—Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–∞.\n\n–ö–û–ù–¢–ï–ö–°–¢:\n- –†–∞—Å–∫–ª–∞–¥ \"${spreadConfig.name}\"\n- –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–∫—É—Å: ${currentSpread.focus}\n- –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∞—è —Ç–µ–º–∞: ${currentSpread.energy}\n- –í—Å–µ –∫–∞—Ä—Ç—ã —Å–≤—è–∑–∞–Ω—ã –µ–¥–∏–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π\n\n–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:\n- –î–ª–∏–Ω–∞: 600-900 —Å–∏–º–≤–æ–ª–æ–≤\n- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –æ–±—â–∏–π –æ–±–∑–æ—Ä ‚Üí –∫–ª—é—á–µ–≤—ã–µ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ ‚Üí –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã ‚Üí –∑–∞–∫–ª—é—á–µ–Ω–∏–µ\n- –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–π –∫–∞—Ä—Ç—ã –∫–∞–∫ –µ–¥–∏–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≤–∏—Ç–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏\n\n–û–°–û–ë–ï–ù–ù–û–°–¢–ò –†–ê–°–ö–õ–ê–î–ê:\n${spreadConfig.description}\n\n–ü–†–ò–ù–¶–ò–ü–´ –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–ò:\n- –ü–æ–∫–∞–∂–∏, –∫–∞–∫ –ø–æ–∑–∏—Ü–∏–∏ –≤–ª–∏—è—é—Ç –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞\n- –ù–∞–π–¥–∏ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é —Ç–µ–º—É –≤—Å–µ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–∞\n- –£—á–∏—Ç—ã–≤–∞–π –±–∞–ª–∞–Ω—Å –ø—Ä—è–º—ã—Ö –∏ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—ã—Ö –∫–∞—Ä—Ç\n- –î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –ø—Ä–∏–º–µ–Ω–∏–º—ã–µ —Å–æ–≤–µ—Ç—ã`;\n\n        const positions = spreadConfig.cards || [];\n        \n        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∫–∞—Ä—Ç —Ä–∞—Å–∫–ª–∞–¥–∞\n        const cardsDescription = cards.map((card, index) => {\n            const position = positions[index] || { \n                label: `–ü–æ–∑–∏—Ü–∏—è ${index + 1}`, \n                description: '–ê–Ω–∞–ª–∏–∑ –∞—Å–ø–µ–∫—Ç–∞ —Å–∏—Ç—É–∞—Ü–∏–∏' \n            };\n            \n            return `${index + 1}. –ü–û–ó–ò–¶–ò–Ø \"${position.label.toUpperCase()}\":\nüÉè –ö–∞—Ä—Ç–∞: \"${card.name}\" ${card.symbol || 'üé¥'}\nüìã –†–æ–ª—å –ø–æ–∑–∏—Ü–∏–∏: ${position.description}\n‚ú® –ó–Ω–∞—á–µ–Ω–∏–µ: ${card.meaningUpright || card.meaning || '–¢—Ä–µ–±—É–µ—Ç –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è'}\nüîë –ö–ª—é—á–µ–≤–∞—è —Ñ—Ä–∞–∑–∞: \"${card.keyPhrase || '–ü—Ä–∏—Å–ª—É—à–∞–π—Ç–µ—Å—å –∫ –∏–Ω—Ç—É–∏—Ü–∏–∏'}\"\nüîÑ –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è: ${card.isReversed ? '–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∞—Å–ø–µ–∫—Ç—ã)' : '–ø—Ä—è–º–∞—è (–∞–∫—Ç–∏–≤–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è)'}`;\n        }).join('\\n\\n');\n        \n        userMessage = `–†–ê–°–ö–õ–ê–î \"${spreadConfig.name}\" –¥–ª—è ${userName}\n–¢–µ–º–∞ –∑–∞–ø—Ä–æ—Å–∞: \"${question}\"\n\n–ö–ê–†–¢–´ –†–ê–°–ö–õ–ê–î–ê:\n${cardsDescription}\n\n–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó:\n- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç: ${cards.length}\n- –ü—Ä—è–º—ã—Ö –∫–∞—Ä—Ç: ${cards.filter(c => !c.isReversed).length}\n- –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—ã—Ö –∫–∞—Ä—Ç: ${cards.filter(c => c.isReversed).length}\n- –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å: ${cards.filter(c => !c.isReversed).length > cards.filter(c => c.isReversed).length ? '–ø—Ä–µ–æ–±–ª–∞–¥–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è' : cards.filter(c => c.isReversed).length > cards.filter(c => !c.isReversed).length ? '—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ä–∞–±–æ—Ç–∞' : '–±–∞–ª–∞–Ω—Å –≤–Ω–µ—à–Ω–µ–≥–æ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ'}\n\n–ó–ê–î–ê–ß–ê: –°–æ–∑–¥–∞–π —Ü–µ–ª–æ—Å—Ç–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é, –ø–æ–∫–∞–∑—ã–≤–∞—é—â—É—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –≤—Å–µ—Ö –∫–∞—Ä—Ç –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –ø–æ–∑–∏—Ü–∏–∏ —Ä–∞—Å–∫–ª–∞–¥–∞.`;\n        break;\n\n    // ========================================================================\n    // üö´ DEFAULT\n    // ========================================================================\n    default:\n        systemMessage = `${basePersonality}\n\n–ó–ê–î–ê–ß–ê: –î–∞—Ç—å –º—É–¥—Ä—ã–π —Å–æ–≤–µ—Ç —á–µ—Ä–µ–∑ –∫–∞—Ä—Ç—ã.\n–§–û–†–ú–ê–¢: 200-400 —Å–∏–º–≤–æ–ª–æ–≤, –ø–æ–Ω—è—Ç–Ω—ã–π –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π.`;\n\n        const defaultCard = cards[0];\n        userMessage = `–ó–∞–ø—Ä–æ—Å –æ—Ç ${userName}: \"${question || '–æ–±—â–µ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ'}\"\n–ö–∞—Ä—Ç–∞: \"${defaultCard.name}\" ${defaultCard.symbol || 'üé¥'}\n–ó–Ω–∞—á–µ–Ω–∏–µ: ${defaultCard.meaning || defaultCard.meaningUpright}`;\n        break;\n}\n\n// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞\nconsole.log('‚úÖ Prompts generated successfully:', {\n    requestType,\n    userName,\n    systemLength: systemMessage.length,\n    userLength: userMessage.length,\n    cardsProcessed: cards.length,\n    spreadConfigName: additionalData.spreadConfig?.name\n});\n\n// –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞\nreturn {\n    systemMessage: systemMessage.trim(),\n    userMessage: userMessage.trim(),\n    requestType: requestType,\n    userName: userName,\n    originalData: inputData,\n    processedCards: cards,\n    metadata: {\n        promptGenerated: true,\n        timestamp: new Date().toISOString(),\n        cardsCount: cards.length,\n        hasContext: requestType === 'clarifying_question' && additionalData.originalAnswer,\n        spreadConfig: additionalData.spreadConfig?.name,\n        dataSource: 'workflow_final'\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        944,
        688
      ],
      "id": "70e0c299-31bb-4446-b028-6e5bee8c57e2",
      "name": "Generate Adaptive Prompts"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        720,
        688
      ],
      "id": "c1236e53-1dae-47de-bd3c-fe86b336751e",
      "name": "Merge"
    }
  ],
  "pinData": {},
  "connections": {
    "Check User ID": {
      "main": [
        [
          {
            "node": "Find User",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Guest User Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Registered User Data": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "WebApp Webhook": {
      "main": [
        [
          {
            "node": "Check OPTIONS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check OPTIONS": {
      "main": [
        [
          {
            "node": "OPTIONS Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process WebApp Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process WebApp Data": {
      "main": [
        [
          {
            "node": "Check User ID",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find User": {
      "main": [
        [
          {
            "node": "Prepare Registered User Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Prepare Final Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Final Response": {
      "main": [
        [
          {
            "node": "Final Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Adaptive Prompts": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Generate Adaptive Prompts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "b93f1d9b-e4af-474a-8a40-5142798299c5",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "6cad6c126517b400f4c184c0dab99010767f9f501361323a0faac97bc6800ce1"
  },
  "id": "RkuQeYAPrMF4XpIR",
  "tags": [
    {
      "createdAt": "2025-07-01T16:52:37.157Z",
      "updatedAt": "2025-07-01T16:53:08.699Z",
      "id": "eTmtbMgJp4PZFCsW",
      "name": "—Ç–∞—Ä–æ"
    }
  ]
}