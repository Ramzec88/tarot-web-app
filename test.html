<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Debug Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4ecdc4;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-label {
            font-weight: 600;
        }

        .status-value {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .status-success { color: #51cf66; }
        .status-error { color: #ff6b6b; }
        .status-warning { color: #ffd43b; }
        .status-info { color: #74c0fc; }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }

        .btn.warning {
            background: linear-gradient(135deg, #ffd43b, #ffc107);
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px 15px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
            color: #ffd700;
        }

        .data-table td {
            font-family: monospace;
            font-size: 0.9rem;
        }

        .query-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-family: monospace;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 80px;
        }

        .query-input::placeholder {
            color: #888;
        }

        .logs {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            word-wrap: break-word;
        }

        .log-timestamp {
            color: #868e96;
            margin-right: 10px;
        }

        .log-success { color: #51cf66; }
        .log-error { color: #ff6b6b; }
        .log-warning { color: #ffd43b; }
        .log-info { color: #74c0fc; }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #4ecdc4;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden { display: none; }

        .json-viewer {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            max-height: 300px;
            overflow: auto;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Supabase Debug Tool</h1>
            <p>–û—Ç–ª–∞–¥–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö</p>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç—É—Å–∞ -->
        <div class="status-panel" id="statusPanel">
            <div class="status-item">
                <span class="status-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</span>
                <span class="status-value status-info" id="connectionStatus">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
            </div>
            <div class="status-item">
                <span class="status-label">URL Supabase:</span>
                <span class="status-value" id="supabaseUrl">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="status-item">
                <span class="status-label">SDK –≤–µ—Ä—Å–∏—è:</span>
                <span class="status-value" id="sdkVersion">–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω</span>
            </div>
            <div class="status-item">
                <span class="status-label">–ê–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∏–µ–Ω—Ç:</span>
                <span class="status-value" id="activeClient">–ù–µ—Ç</span>
            </div>
        </div>

        <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="controls">
            <button class="btn" id="initSupabase">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button class="btn" id="testConnection">üîç –¢–µ—Å—Ç —Å–≤—è–∑–∏</button>
            <button class="btn warning" id="checkTables">üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã</button>
            <button class="btn" id="runDiagnostic">ü©∫ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
            <button class="btn" id="createTestUser">üë§ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            <button class="btn danger" id="clearLogs">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <div class="tab active" data-tab="queries">SQL –ó–∞–ø—Ä–æ—Å—ã</div>
            <div class="tab" data-tab="tables">–¢–∞–±–ª–∏—Ü—ã</div>
            <div class="tab" data-tab="realtime">Realtime</div>
            <div class="tab" data-tab="auth">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
        <div class="tab-content active" id="queries">
            <h3>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤</h3>
            <textarea class="query-input" id="sqlQuery" placeholder="–í–≤–µ–¥–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä:

-- –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:
SELECT * FROM tarot_user_profiles LIMIT 5;
SELECT COUNT(*) FROM tarot_user_profiles;
INSERT INTO tarot_user_profiles (telegram_id, username) VALUES ('test123', 'testuser');
"></textarea>
            <button class="btn" id="executeQuery">‚ñ∂Ô∏è –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
            <button class="btn warning" id="loadExamples">üìã –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤</button>
            <div class="json-viewer" id="queryResult">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</div>
        </div>

        <div class="tab-content" id="tables">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞–±–ª–∏—Ü–∞—Ö</h3>
            <button class="btn" id="loadTables">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <table class="data-table" id="tablesInfo">
                <thead>
                    <tr>
                        <th>–¢–∞–±–ª–∏—Ü–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ó–∞–ø–∏—Å–µ–π</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="tab-content" id="realtime">
            <h3>Realtime –ø–æ–¥–ø–∏—Å–∫–∏</h3>
            <button class="btn" id="subscribeToChanges">üî¥ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <button class="btn danger" id="unsubscribe">‚èπÔ∏è –û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button>
            <div class="json-viewer" id="realtimeEvents">–°–æ–±—ã—Ç–∏—è Realtime –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</div>
        </div>

        <div class="tab-content" id="auth">
            <h3>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ RLS</h3>
            <button class="btn" id="checkAuth">üîê –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
            <button class="btn" id="testRLS">üõ°Ô∏è –¢–µ—Å—Ç RLS –ø–æ–ª–∏—Ç–∏–∫</button>
            <div class="json-viewer" id="authInfo">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</div>
        </div>

        <!-- –õ–æ–≥–∏ -->
        <div class="logs" id="logContainer"></div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const SUPABASE_CONFIG = {
            url: 'https://xqtokipsfzywippmvpgp.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxdG9raXBzZnp5d2lwcG12cGdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzEwNzAyNDQsImV4cCI6MjA0NjY0NjI0NH0.GgwhQgjWLrOj4zYoL6S7_3iuYdO4ufcRsAWY_wqtTkY'
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let supabaseClient = null;
        let realtimeChannel = null;

        // –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        const logger = {
            log(message, type = 'info', data = null) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                let logContent = `<span class="log-timestamp">[${timestamp}]</span><span class="log-${type}">${message}</span>`;
                
                if (data) {
                    logContent += `\n<div style="margin-left: 80px; margin-top: 5px; font-size: 0.8rem; opacity: 0.8;">${JSON.stringify(data, null, 2)}</div>`;
                }
                
                logEntry.innerHTML = logContent;
                document.getElementById('logContainer').appendChild(logEntry);
                document.getElementById('logContainer').scrollTop = document.getElementById('logContainer').scrollHeight;
                
                console.log(`[${timestamp}] ${message}`, data || '');
            },
            
            success(message, data) { this.log(`‚úÖ ${message}`, 'success', data); },
            error(message, data) { this.log(`‚ùå ${message}`, 'error', data); },
            warning(message, data) { this.log(`‚ö†Ô∏è ${message}`, 'warning', data); },
            info(message, data) { this.log(`‚ÑπÔ∏è ${message}`, 'info', data); }
        };

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus() {
            document.getElementById('supabaseUrl').textContent = SUPABASE_CONFIG.url;
            document.getElementById('connectionStatus').textContent = supabaseClient ? '–ü–æ–¥–∫–ª—é—á–µ–Ω' : '–û—Ç–∫–ª—é—á–µ–Ω';
            document.getElementById('connectionStatus').className = `status-value ${supabaseClient ? 'status-success' : 'status-error'}`;
            document.getElementById('sdkVersion').textContent = window.supabase ? '–ó–∞–≥—Ä—É–∂–µ–Ω' : '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω';
            document.getElementById('activeClient').textContent = supabaseClient ? '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '–ù–µ—Ç';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ Supabase SDK
        async function loadSupabaseSDK() {
            if (window.supabase) return true;

            return new Promise((resolve, reject) => {
                logger.info('–ó–∞–≥—Ä—É–∑–∫–∞ Supabase SDK...');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                script.onload = () => {
                    logger.success('Supabase SDK –∑–∞–≥—Ä—É–∂–µ–Ω');
                    updateStatus();
                    resolve(true);
                };
                script.onerror = () => {
                    logger.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Supabase SDK');
                    reject(new Error('Failed to load SDK'));
                };
                document.head.appendChild(script);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        async function initializeSupabase() {
            try {
                await loadSupabaseSDK();

                supabaseClient = window.supabase.createClient(
                    SUPABASE_CONFIG.url,
                    SUPABASE_CONFIG.anonKey,
                    {
                        auth: {
                            persistSession: false,
                            autoRefreshToken: false
                        },
                        db: {
                            schema: 'public'
                        },
                        global: {
                            headers: {
                                'X-Client-Info': 'debug-tool'
                            }
                        }
                    }
                );

                logger.success('Supabase –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                updateStatus();
                return true;

            } catch (error) {
                logger.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase', error);
                return false;
            }
        }

        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function testConnection() {
            if (!supabaseClient) {
                logger.warning('–°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ Supabase');
                return;
            }

            try {
                logger.info('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
                
                const startTime = performance.now();
                const { data, error } = await supabaseClient
                    .from('tarot_user_profiles')
                    .select('count')
                    .limit(1);
                const endTime = performance.now();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                logger.success(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (${Math.round(endTime - startTime)}ms)`, {
                    data: data,
                    responseTime: `${Math.round(endTime - startTime)}ms`
                });

            } catch (error) {
                logger.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', error);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü
        async function checkTables() {
            if (!supabaseClient) {
                logger.warning('–°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ Supabase');
                return;
            }

            const tables = [
                'tarot_user_profiles',
                'tarot_questions',
                'tarot_answers', 
                'tarot_daily_cards',
                'tarot_reviews',
                'tarot_spreads'
            ];

            logger.info('–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü...');
            
            const tableResults = [];
            
            for (const table of tables) {
                try {
                    const { data, error, count } = await supabaseClient
                        .from(table)
                        .select('*', { count: 'exact', head: true });

                    if (error && error.code !== 'PGRST116') {
                        tableResults.push({
                            table,
                            status: 'error',
                            message: error.message,
                            count: 0
                        });
                    } else {
                        tableResults.push({
                            table,
                            status: 'success',
                            message: '–î–æ—Å—Ç—É–ø–Ω–∞',
                            count: count || 0
                        });
                    }
                } catch (err) {
                    tableResults.push({
                        table,
                        status: 'error',
                        message: err.message,
                        count: 0
                    });
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            updateTablesDisplay(tableResults);
            logger.success('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü –∑–∞–≤–µ—Ä—à–µ–Ω–∞', tableResults);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü
        function updateTablesDisplay(results) {
            const tbody = document.querySelector('#tablesInfo tbody');
            tbody.innerHTML = '';

            results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.table}</td>
                    <td class="status-${result.status}">${result.message}</td>
                    <td>${result.count}</td>
                    <td>
                        <button class="btn" onclick="inspectTable('${result.table}')">üîç –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–∞–±–ª–∏—Ü—ã
        async function inspectTable(tableName) {
            if (!supabaseClient) return;

            try {
                const { data, error } = await supabaseClient
                    .from(tableName)
                    .select('*')
                    .limit(5);

                if (error) throw error;

                logger.info(`–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–ª–∏—Ü—ã ${tableName}`, data);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ JSON viewer
                document.getElementById('queryResult').textContent = JSON.stringify(data, null, 2);
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤
                switchTab('queries');

            } catch (error) {
                logger.error(`–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã ${tableName}`, error);
            }
        }

        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–∞
        async function executeQuery() {
            if (!supabaseClient) {
                logger.warning('–°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ Supabase');
                return;
            }

            const query = document.getElementById('sqlQuery').value.trim();
            if (!query) {
                logger.warning('–í–≤–µ–¥–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å');
                return;
            }

            try {
                logger.info('–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞...', { query });
                
                const startTime = performance.now();
                const { data, error } = await supabaseClient.rpc('execute_sql', { query });
                const endTime = performance.now();

                if (error) throw error;

                logger.success(`–ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω (${Math.round(endTime - startTime)}ms)`, data);
                document.getElementById('queryResult').textContent = JSON.stringify(data, null, 2);

            } catch (error) {
                logger.error('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞', error);
                
                // –ü–æ–ø—Ä–æ–±—É–µ–º –æ–±—ã—á–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                try {
                    const tableName = query.match(/FROM\s+(\w+)/i)?.[1];
                    if (tableName && query.toLowerCase().includes('select')) {
                        const { data, error } = await supabaseClient
                            .from(tableName)
                            .select('*')
                            .limit(10);
                        
                        if (!error) {
                            logger.info('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞', data);
                            document.getElementById('queryResult').textContent = JSON.stringify(data, null, 2);
                        }
                    }
                } catch (altError) {
                    logger.error('–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ —Ç–æ–∂–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª', altError);
                }
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function createTestUser() {
            if (!supabaseClient) {
                logger.warning('–°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ Supabase');
                return;
            }

            try {
                const testUser = {
                    telegram_id: `debug_${Date.now()}`,
                    username: 'debug_user',
                    first_name: 'Debug',
                    last_name: 'User',
                    is_premium: false,
                    questions_used: 0,
                    created_at: new Date().toISOString()
                };

                logger.info('–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...', testUser);

                const { data, error } = await supabaseClient
                    .from('tarot_user_profiles')
                    .insert([testUser])
                    .select();

                if (error) throw error;

                logger.success('–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω', data[0]);

            } catch (error) {
                logger.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', error);
            }
        }

        // –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        async function runDiagnostic() {
            logger.info('=== –ó–ê–ü–£–°–ö –ü–û–õ–ù–û–ô –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===');

            // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            const initResult = await initializeSupabase();
            if (!initResult) return;

            // 2. –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            await testConnection();

            // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü
            await checkTables();

            // 4. –¢–µ—Å—Ç –±–∞–∑–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
            await testCRUDOperations();

            logger.info('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===');
        }

        // –¢–µ—Å—Ç CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
        async function testCRUDOperations() {
            if (!supabaseClient) return;

            try {
                logger.info('–¢–µ—Å—Ç CRUD –æ–ø–µ—Ä–∞—Ü–∏–π...');

                const testId = `crud_test_${Date.now()}`;

                // CREATE
                const { data: created, error: createError } = await supabaseClient
                    .from('tarot_user_profiles')
                    .insert([{
                        telegram_id: testId,
                        username: 'crud_test',
                        is_premium: false,
                        questions_used: 0
                    }])
                    .select();

                if (createError) throw new Error(`CREATE failed: ${createError.message}`);

                // READ
                const { data: read, error: readError } = await supabaseClient
                    .from('tarot_user_profiles')
                    .select('*')
                    .eq('telegram_id', testId);

                if (readError) throw new Error(`READ failed: ${readError.message}`);

                // UPDATE
                const { data: updated, error: updateError } = await supabaseClient
                    .from('tarot_user_profiles')
                    .update({ questions_used: 1 })
                    .eq('telegram_id', testId)
                    .select();

                if (updateError) throw new Error(`UPDATE failed: ${updateError.message}`);

                // DELETE
                const { error: deleteError } = await supabaseClient
                    .from('tarot_user_profiles')
                    .delete()
                    .eq('telegram_id', testId);

                if (deleteError) throw new Error(`DELETE failed: ${deleteError.message}`);

                logger.success('CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');

            } catch (error) {
                logger.error('–û—à–∏–±–∫–∞ CRUD –æ–ø–µ—Ä–∞—Ü–∏–π', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
        function loadExamples() {
            const examples = [
                "-- –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\nSELECT * FROM tarot_user_profiles LIMIT 5;",
                "-- –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\nSELECT COUNT(*) FROM tarot_user_profiles;",
                "-- –ù–∞–π—Ç–∏ –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\nSELECT * FROM tarot_user_profiles WHERE is_premium = true;",
                "-- –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–æ–ø—Ä–æ—Å—ã\nSELECT * FROM tarot_questions ORDER BY created_at DESC LIMIT 10;",
                "-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é\nSELECT \n  COUNT(*) as total_users,\n  COUNT(CASE WHEN is_premium THEN 1 END) as premium_users\nFROM tarot_user_profiles;"
            ].join('\n\n');

            document.getElementById('sqlQuery').value = examples;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Realtime —Å–æ–±—ã—Ç–∏—è
        async function subscribeToChanges() {
            if (!supabaseClient) {
                logger.warning('–°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ Supabase');
                return;
            }

            try {
                realtimeChannel = supabaseClient
                    .channel('debug-channel')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'tarot_user_profiles' },
                        (payload) => {
                            logger.info('Realtime —Å–æ–±—ã—Ç–∏–µ', payload);
                            document.getElementById('realtimeEvents').textContent = JSON.stringify(payload, null, 2);
                        }
                    )
                    .subscribe((status) => {
                        logger.info(`Realtime –ø–æ–¥–ø–∏—Å–∫–∞: ${status}`);
                    });

                logger.success('–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Realtime —Å–æ–±—ã—Ç–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');

            } catch (error) {
                logger.error('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ Realtime', error);
            }
        }

        // –û—Ç–ø–∏—Å–∫–∞ –æ—Ç Realtime
        function unsubscribe() {
            if (realtimeChannel) {
                supabaseClient.removeChannel(realtimeChannel);
                realtimeChannel = null;
                logger.success('–û—Ç–ø–∏—Å–∫–∞ –æ—Ç Realtime —Å–æ–±—ã—Ç–∏–π');
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            logger.info('–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('initSupabase').addEventListener('click', initializeSupabase);
            document.getElementById('testConnection').addEventListener('click', testConnection);
            document.getElementById('checkTables').addEventListener('click', checkTables);
            document.getElementById('runDiagnostic').addEventListener('click', runDiagnostic);
            document.getElementById('createTestUser').addEventListener('click', createTestUser);
            document.getElementById('clearLogs').addEventListener('click', clearLogs);
            document.getElementById('executeQuery').addEventListener('click', executeQuery);
            document.getElementById('loadExamples').addEventListener('click', loadExamples);
            document.getElementById('loadTables').addEventListener('click', checkTables);
            document.getElementById('subscribeToChanges').addEventListener('click', subscribeToChanges);
            document.getElementById('unsubscribe').addEventListener('click', unsubscribe);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            document.getElementById('checkAuth').addEventListener('click', async () => {
                if (!supabaseClient) {
                    logger.warning('–°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ Supabase');
                    return;
                }

                try {
                    const { data: { user }, error } = await supabaseClient.auth.getUser();
                    
                    const authInfo = {
                        user: user,
                        session: await supabaseClient.auth.getSession(),
                        isAuthenticated: !!user
                    };

                    logger.info('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', authInfo);
                    document.getElementById('authInfo').textContent = JSON.stringify(authInfo, null, 2);

                } catch (error) {
                    logger.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', error);
                }
            });

            // –¢–µ—Å—Ç RLS –ø–æ–ª–∏—Ç–∏–∫
            document.getElementById('testRLS').addEventListener('click', async () => {
                if (!supabaseClient) {
                    logger.warning('–°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ Supabase');
                    return;
                }

                try {
                    logger.info('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RLS –ø–æ–ª–∏—Ç–∏–∫...');

                    // –¢–µ—Å—Ç –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (anon –∫–ª—é—á)
                    const { data: anonData, error: anonError } = await supabaseClient
                        .from('tarot_user_profiles')
                        .select('*')
                        .limit(1);

                    const rlsInfo = {
                        anonymousAccess: {
                            success: !anonError,
                            error: anonError?.message,
                            data: anonData
                        }
                    };

                    logger.info('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è RLS', rlsInfo);
                    document.getElementById('authInfo').textContent = JSON.stringify(rlsInfo, null, 2);

                } catch (error) {
                    logger.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è RLS', error);
                }
            });

            logger.info('üîß Debug Tool –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
            logger.info('–ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã');
        });

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
        window.SupabaseDebug = {
            client: () => supabaseClient,
            config: SUPABASE_CONFIG,
            logger,
            testConnection,
            checkTables,
            runDiagnostic,
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä—É—á–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏
            async rawQuery(query) {
                if (!supabaseClient) {
                    console.error('Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    return;
                }
                
                try {
                    const result = await supabaseClient.rpc('execute_sql', { query });
                    console.log('Query result:', result);
                    return result;
                } catch (error) {
                    console.error('Query error:', error);
                    return error;
                }
            },

            async inspectTable(tableName, limit = 10) {
                if (!supabaseClient) {
                    console.error('Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    return;
                }

                try {
                    const { data, error } = await supabaseClient
                        .from(tableName)
                        .select('*')
                        .limit(limit);
                    
                    console.table(data);
                    return { data, error };
                } catch (error) {
                    console.error('Inspect error:', error);
                    return error;
                }
            },

            async getTableSchema(tableName) {
                if (!supabaseClient) {
                    console.error('Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    return;
                }

                try {
                    // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é —Å—Ö–µ–º—É
                    const query = `
                        SELECT column_name, data_type, is_nullable 
                        FROM information_schema.columns 
                        WHERE table_name = '${tableName}' 
                        AND table_schema = 'public'
                    `;
                    
                    const result = await this.rawQuery(query);
                    console.table(result.data);
                    return result;
                } catch (error) {
                    console.error('Schema error:', error);
                    return error;
                }
            },

            // –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
            async quickTest() {
                console.log('=== –ë–´–°–¢–†–´–ô –¢–ï–°–¢ SUPABASE ===');
                
                if (!supabaseClient) {
                    await initializeSupabase();
                }

                await testConnection();
                await checkTables();
                await testCRUDOperations();

                console.log('=== –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù ===');
            }
        };

        console.log('üîß Supabase Debug Tool –∑–∞–≥—Ä—É–∂–µ–Ω');
        console.log('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ window.SupabaseDebug –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏');
        console.log('–ü—Ä–∏–º–µ—Ä: SupabaseDebug.quickTest()');
    </script>
</body>
</html>
