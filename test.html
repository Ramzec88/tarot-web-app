<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Supabase - Tarot App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .alert {
            background: rgba(255, 107, 107, 0.2);
            border: 2px solid #ff6b6b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .alert-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff6b6b;
        }

        .diagnostic-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #4ecdc4;
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #4ecdc4;
            display: flex;
            align-items: center;
        }

        .section-icon {
            margin-right: 10px;
            font-size: 1.4rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }

        .btn.danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .btn.success {
            background: linear-gradient(135deg, #51cf66, #40c057);
        }

        .btn.warning {
            background: linear-gradient(135deg, #ffd43b, #fab005);
            color: #1a1a2e;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #4ecdc4;
        }

        .result-panel.error {
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .result-panel.success {
            border-left-color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
        }

        .result-panel.warning {
            border-left-color: #ffd43b;
            background: rgba(255, 212, 59, 0.1);
        }

        .code-block {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            margin: 15px 0;
            overflow-x: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            white-space: pre-wrap;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #666;
        }

        .status-card.success {
            border-left-color: #51cf66;
        }

        .status-card.error {
            border-left-color: #ff6b6b;
        }

        .status-card.warning {
            border-left-color: #ffd43b;
        }

        .status-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #fff;
        }

        .status-value {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: flex-start;
        }

        .log-timestamp {
            color: #868e96;
            margin-right: 10px;
            min-width: 80px;
        }

        .log-success { color: #51cf66; }
        .log-error { color: #ff6b6b; }
        .log-warning { color: #ffd43b; }
        .log-info { color: #74c0fc; }

        .hidden { display: none; }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 5px;
            color: #b0b0b0;
            font-weight: 500;
        }

        .input-field {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 14px;
        }

        .input-field::placeholder {
            color: #888;
        }

        @media (max-width: 768px) {
            .container { 
                padding: 20px; 
                margin: 10px;
            }
            .controls { 
                grid-template-columns: 1fr; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Supabase</h1>
            <p>–ù–∞–π–¥–µ–º –∏ –∏—Å–ø—Ä–∞–≤–∏–º –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö</p>
        </div>

        <div class="alert">
            <div class="alert-title">üö® –ü—Ä–æ–±–ª–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞</div>
            <p>–î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—ã Supabase. –ó–∞–ø—É—Å—Ç–∏–º –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω.</p>
        </div>

        <div class="diagnostic-section">
            <div class="section-title">
                <span class="section-icon">üîë</span>
                –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            </div>
            <div class="input-group">
                <label class="input-label">Supabase URL:</label>
                <input type="text" class="input-field" id="supabaseUrl" value="https://jjowuzqfnwcuulcknkxh.supabase.co" readonly>
            </div>
            <div class="input-group">
                <label class="input-label">Anon Key (–≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–ª—é—á):</label>
                <input type="password" class="input-field" id="supabaseKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à anon key">
            </div>
        </div>

        <div class="controls">
            <button class="btn" id="testConnection">üîó –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
            <button class="btn warning" id="checkTables">üìã –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã</button>
            <button class="btn success" id="testInsert">üíæ –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏</button>
            <button class="btn danger" id="checkRLS">üîí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RLS</button>
            <button class="btn" id="runFullDiagnostic">üöÄ –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
            <button class="btn" id="clearLogs">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>

        <div class="status-grid" id="statusGrid"></div>

        <div class="log-container" id="logContainer"></div>

        <div class="result-panel hidden" id="solutionPanel">
            <h4>üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ä–µ—à–µ–Ω–∏—è</h4>
            <div id="solutionContent"></div>
        </div>
    </div>

    <script>
        let supabaseClient = null;

        // –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        const logger = {
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span>
                    <span class="log-${type}">${message}</span>
                `;
                document.getElementById('logContainer').appendChild(logEntry);
                document.getElementById('logContainer').scrollTop = document.getElementById('logContainer').scrollHeight;
                console.log(`[${timestamp}] ${message}`);
            },
            
            success(message) { this.log(`‚úÖ ${message}`, 'success'); },
            error(message) { this.log(`‚ùå ${message}`, 'error'); },
            warning(message) { this.log(`‚ö†Ô∏è ${message}`, 'warning'); },
            info(message) { this.log(`‚ÑπÔ∏è ${message}`, 'info'); }
        };

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
        function createStatusCard(title, value, status = 'info') {
            const card = document.createElement('div');
            card.className = `status-card ${status}`;
            card.innerHTML = `
                <div class="status-title">${title}</div>
                <div class="status-value">${value}</div>
            `;
            return card;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus() {
            const grid = document.getElementById('statusGrid');
            grid.innerHTML = '';

            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            grid.appendChild(createStatusCard(
                'üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ',
                supabaseClient ? '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ' : '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ',
                supabaseClient ? 'success' : 'error'
            ));

            grid.appendChild(createStatusCard(
                'üîë –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è',
                key ? 'API –∫–ª—é—á –≤–≤–µ–¥–µ–Ω' : 'API –∫–ª—é—á –Ω–µ –≤–≤–µ–¥–µ–Ω',
                key ? 'success' : 'warning'
            ));

            grid.appendChild(createStatusCard(
                'üìä URL',
                url || '–ù–µ –∑–∞–¥–∞–Ω',
                url ? 'success' : 'error'
            ));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ Supabase SDK
        async function loadSupabaseSDK() {
            if (window.supabase) return true;

            logger.info('–ó–∞–≥—Ä—É–∑–∫–∞ Supabase SDK...');
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                script.onload = () => {
                    logger.success('Supabase SDK –∑–∞–≥—Ä—É–∂–µ–Ω');
                    resolve(true);
                };
                script.onerror = () => {
                    logger.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Supabase SDK');
                    reject(false);
                };
                document.head.appendChild(script);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –∫–ª–∏–µ–Ω—Ç–∞
        async function initializeSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;

            if (!url || !key) {
                logger.error('URL –∏–ª–∏ API –∫–ª—é—á –Ω–µ –∑–∞–¥–∞–Ω—ã');
                return false;
            }

            try {
                await loadSupabaseSDK();
                
                supabaseClient = window.supabase.createClient(url, key, {
                    auth: {
                        persistSession: false,
                        autoRefreshToken: false,
                        detectSessionInUrl: false
                    },
                    db: {
                        schema: 'public'
                    },
                    global: {
                        headers: {
                            'x-application': 'tarot-diagnostic'
                        }
                    }
                });

                logger.success('Supabase –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                updateStatus();
                return true;

            } catch (error) {
                logger.error(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`);
                return false;
            }
        }

        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function testConnection() {
            if (!await initializeSupabase()) return false;

            logger.info('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const { data, error } = await supabaseClient
                    .from('tarot_user_profiles')
                    .select('count', { count: 'exact', head: true })
                    .abortSignal(controller.signal);

                clearTimeout(timeoutId);

                if (error) {
                    logger.error(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
                    logger.info(`–ö–æ–¥ –æ—à–∏–±–∫–∏: ${error.code}`);
                    logger.info(`–î–µ—Ç–∞–ª–∏: ${error.details || '–Ω–µ—Ç'}`);
                    return false;
                }

                logger.success('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ');
                logger.info(`–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${data || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
                updateStatus();
                return true;

            } catch (error) {
                if (error.name === 'AbortError') {
                    logger.error('–¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–±–æ–ª–µ–µ 10 —Å–µ–∫—É–Ω–¥)');
                } else {
                    logger.error(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
                }
                return false;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü
        async function checkTables() {
            if (!supabaseClient) {
                logger.warning('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                return false;
            }

            const tables = [
                'tarot_user_profiles',
                'tarot_daily_cards', 
                'tarot_questions',
                'tarot_answers',
                'tarot_reviews'
            ];

            logger.info('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü...');

            for (const tableName of tables) {
                try {
                    logger.info(`–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É: ${tableName}`);

                    const { data, error } = await supabaseClient
                        .from(tableName)
                        .select('*')
                        .limit(1);

                    if (error) {
                        logger.error(`–¢–∞–±–ª–∏—Ü–∞ ${tableName}: ${error.message}`);
                        
                        if (error.code === '42P01') {
                            logger.warning(`–¢–∞–±–ª–∏—Ü–∞ ${tableName} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!`);
                        } else if (error.code === '42501') {
                            logger.warning(`–ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ ${tableName}`);
                        }
                    } else {
                        logger.success(`–¢–∞–±–ª–∏—Ü–∞ ${tableName}: –¥–æ—Å—Ç—É–ø–Ω–∞`);
                        
                        if (data && data.length > 0) {
                            const columns = Object.keys(data[0]);
                            logger.info(`–ö–æ–ª–æ–Ω–∫–∏: ${columns.join(', ')}`);
                        } else {
                            logger.info('–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞');
                        }
                    }

                } catch (error) {
                    logger.error(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ ${tableName}: ${error.message}`);
                }

                // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            return true;
        }

        // –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö
        async function testInsert() {
            if (!supabaseClient) {
                logger.warning('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                return false;
            }

            logger.info('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö...');

            try {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π test ID
                const testId = `test_${Date.now()}`;
                
                logger.info(`–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å telegram_id: ${testId}`);

                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const { data, error } = await supabaseClient
                    .from('tarot_user_profiles')
                    .insert([
                        {
                            telegram_id: testId,
                            username: 'test_diagnostic',
                            is_subscribed: false,
                            questions_used: 0,
                            free_predictions_left: 3
                        }
                    ])
                    .select();

                if (error) {
                    logger.error(`–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${error.message}`);
                    logger.info(`–ö–æ–¥ –æ—à–∏–±–∫–∏: ${error.code}`);
                    logger.info(`–î–µ—Ç–∞–ª–∏: ${error.details || '–Ω–µ—Ç'}`);
                    
                    // –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
                    if (error.code === '23505') {
                        logger.warning('–ö–æ–Ω—Ñ–ª–∏–∫—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ - –≤–æ–∑–º–æ–∂–Ω–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                    } else if (error.code === '42501') {
                        logger.error('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏!');
                    } else if (error.code === '23502') {
                        logger.error('–ù–∞—Ä—É—à–µ–Ω–∏–µ NOT NULL –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è');
                    }
                    
                    return false;
                }

                logger.success('–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–∞!');
                logger.info(`–ó–∞–ø–∏—Å–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID: ${data[0]?.id}`);

                // –û—á–∏—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                await supabaseClient
                    .from('tarot_user_profiles')
                    .delete()
                    .eq('telegram_id', testId);

                logger.info('–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
                return true;

            } catch (error) {
                logger.error(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${error.message}`);
                return false;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS –ø–æ–ª–∏—Ç–∏–∫
        async function checkRLS() {
            if (!supabaseClient) {
                logger.warning('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                return false;
            }

            logger.info('–ü—Ä–æ–≤–µ—Ä–∫–∞ RLS –ø–æ–ª–∏—Ç–∏–∫...');

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–Ω–æ–Ω–∏–º–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü–µ
                const tables = ['tarot_user_profiles', 'tarot_daily_cards', 'tarot_questions', 'tarot_answers', 'tarot_reviews'];

                for (const tableName of tables) {
                    logger.info(`–ü—Ä–æ–≤–µ—Ä—è–µ–º RLS –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã: ${tableName}`);

                    try {
                        // –ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è
                        const { data: readData, error: readError } = await supabaseClient
                            .from(tableName)
                            .select('*')
                            .limit(1);

                        if (readError) {
                            if (readError.code === '42501') {
                                logger.error(`${tableName}: RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç —á—Ç–µ–Ω–∏–µ –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
                            } else {
                                logger.warning(`${tableName}: –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è - ${readError.message}`);
                            }
                        } else {
                            logger.success(`${tableName}: –ß—Ç–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ`);
                        }

                        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã)
                        if (tableName === 'tarot_user_profiles') {
                            const testId = `rls_test_${Date.now()}`;
                            
                            const { error: insertError } = await supabaseClient
                                .from(tableName)
                                .insert([{
                                    telegram_id: testId,
                                    username: 'rls_test'
                                }]);

                            if (insertError) {
                                if (insertError.code === '42501') {
                                    logger.error(`${tableName}: RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
                                } else {
                                    logger.warning(`${tableName}: –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ - ${insertError.message}`);
                                }
                            } else {
                                logger.success(`${tableName}: –ó–∞–ø–∏—Å—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∞`);
                                
                                // –û—á–∏—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                                await supabaseClient
                                    .from(tableName)
                                    .delete()
                                    .eq('telegram_id', testId);
                            }
                        }

                    } catch (error) {
                        logger.error(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ RLS –¥–ª—è ${tableName}: ${error.message}`);
                    }

                    await new Promise(resolve => setTimeout(resolve, 500));
                }

            } catch (error) {
                logger.error(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ RLS: ${error.message}`);
            }
        }

        // –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        async function runFullDiagnostic() {
            logger.info('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...');
            
            const results = {
                connection: false,
                tables: false,
                insert: false,
                rls: false
            };

            // –®–∞–≥ 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            logger.info('--- –®–∞–≥ 1: –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ---');
            results.connection = await testConnection();

            if (!results.connection) {
                showSolution('–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º', [
                    '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å Supabase URL',
                    '–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API –∫–ª—é—á –≤–≤–µ–¥–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ',
                    '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ',
                    '–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Supabase –ø—Ä–æ–µ–∫—Ç –∞–∫—Ç–∏–≤–µ–Ω'
                ]);
                return;
            }

            // –®–∞–≥ 2: –¢–∞–±–ª–∏—Ü—ã
            logger.info('--- –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü ---');
            results.tables = await checkTables();

            // –®–∞–≥ 3: –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏
            logger.info('--- –®–∞–≥ 3: –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ ---');
            results.insert = await testInsert();

            // –®–∞–≥ 4: RLS –ø–æ–ª–∏—Ç–∏–∫–∏
            logger.info('--- –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS ---');
            await checkRLS();

            // –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            logger.info('--- –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ---');
            
            const successCount = Object.values(results).filter(Boolean).length;
            logger.info(`–£—Å–ø–µ—à–Ω–æ: ${successCount}/4 —Ç–µ—Å—Ç–æ–≤`);

            if (successCount === 4) {
                logger.success('üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã! Supabase –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');
            } else {
                logger.warning('‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã, —Å–º. —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∏–∂–µ');
                
                const issues = [];
                if (!results.connection) issues.push('–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                if (!results.tables) issues.push('–ü—Ä–æ–±–ª–µ–º—ã —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏');
                if (!results.insert) issues.push('–ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–ø–∏—Å—å—é –¥–∞–Ω–Ω—ã—Ö');
                
                showSolution('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã', issues);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è
        function showSolution(title, solutions) {
            const panel = document.getElementById('solutionPanel');
            const content = document.getElementById('solutionContent');

            let html = `<p><strong>${title}</strong></p><ul>`;
            solutions.forEach(solution => {
                html += `<li>${solution}</li>`;
            });
            html += `</ul>`;

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è
            html += `<br><h5>üîß –¢–∏–ø–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:</h5>`;
            html += `<div class="code-block">-- –í Supabase SQL Editor –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

-- 1. –í–∫–ª—é—á–∏—Ç—å RLS –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
ALTER TABLE tarot_user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE tarot_daily_cards ENABLE ROW LEVEL SECURITY;
ALTER TABLE tarot_questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE tarot_answers ENABLE ROW LEVEL SECURITY;
ALTER TABLE tarot_reviews ENABLE ROW LEVEL SECURITY;

-- 2. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
CREATE POLICY "Allow anonymous access to tarot_user_profiles" ON tarot_user_profiles
  FOR ALL TO anon USING (true) WITH CHECK (true);

CREATE POLICY "Allow anonymous access to tarot_daily_cards" ON tarot_daily_cards
  FOR ALL TO anon USING (true) WITH CHECK (true);

CREATE POLICY "Allow anonymous access to tarot_questions" ON tarot_questions
  FOR ALL TO anon USING (true) WITH CHECK (true);

CREATE POLICY "Allow anonymous access to tarot_answers" ON tarot_answers
  FOR ALL TO anon USING (true) WITH CHECK (true);

CREATE POLICY "Allow anonymous access to tarot_reviews" ON tarot_reviews
  FOR ALL TO anon USING (true) WITH CHECK (true);</div>`;

            content.innerHTML = html;
            panel.classList.remove('hidden');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('testConnection').addEventListener('click', testConnection);
            document.getElementById('checkTables').addEventListener('click', checkTables);
            document.getElementById('testInsert').addEventListener('click', testInsert);
            document.getElementById('checkRLS').addEventListener('click', checkRLS);
            document.getElementById('runFullDiagnostic').addEventListener('click', runFullDiagnostic);
            
            document.getElementById('clearLogs').addEventListener('click', () => {
                document.getElementById('logContainer').innerHTML = '';
                document.getElementById('solutionPanel').classList.add('hidden');
                logger.info('–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã');
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
            document.getElementById('supabaseKey').addEventListener('input', updateStatus);
            
            updateStatus();
            logger.info('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
        });

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
        window.SupabaseDiagnostic = {
            testConnection,
            checkTables,
            testInsert,
            checkRLS,
            runFullDiagnostic,
            supabaseClient: () => supabaseClient
        };
    </script>
</body>
</html>
