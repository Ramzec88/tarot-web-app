<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-title {
            color: #ffd700;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .config-item {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-family: monospace;
            word-break: break-all;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid #4ecdc4;
            transition: all 0.3s ease;
        }

        .test-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .test-card.error {
            border-left-color: #ff6b6b;
        }

        .test-card.success {
            border-left-color: #51cf66;
        }

        .test-card.warning {
            border-left-color: #ffd43b;
        }

        .test-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .test-icon {
            margin-right: 10px;
            font-size: 1.3rem;
        }

        .test-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background: #868e96;
            animation: pulse 1.5s infinite;
        }

        .test-status.success { background: #51cf66; animation: none; }
        .test-status.error { background: #ff6b6b; animation: none; }
        .test-status.warning { background: #ffd43b; animation: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .test-result {
            font-size: 0.9rem;
            margin-top: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: monospace;
        }

        .btn {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }

        .controls {
            text-align: center;
            margin-bottom: 30px;
        }

        .logs {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-timestamp {
            color: #868e96;
            margin-right: 10px;
        }

        .log-success { color: #51cf66; }
        .log-error { color: #ff6b6b; }
        .log-warning { color: #ffd43b; }
        .log-info { color: #74c0fc; }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #4ecdc4;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Supabase</h1>
            <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</p>
        </div>

        <div class="config-section">
            <div class="config-title">üìã –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</div>
            <div class="config-item" id="supabaseUrl">URL: –ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="config-item" id="supabaseKey">Key: –ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="config-item" id="connectionMode">–†–µ–∂–∏–º: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è...</div>
        </div>

        <div class="controls">
            <button class="btn" id="runAllTests">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
            <button class="btn" id="testBasicConnection">üîó –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
            <button class="btn" id="testTables">üóÑÔ∏è –¢–µ—Å—Ç —Ç–∞–±–ª–∏—Ü</button>
            <button class="btn" id="createTestData">üìù –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç –¥–∞–Ω–Ω—ã–µ</button>
            <button class="btn danger" id="clearLogs">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>

        <div class="test-grid" id="testGrid">
            <div class="test-card" id="networkCard">
                <div class="test-title">
                    <span class="test-icon">üåê</span>
                    <span class="test-status" id="networkStatus"></span>
                    –°–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                </div>
                <div class="test-result" id="networkResult">–û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞...</div>
            </div>

            <div class="test-card" id="sdkCard">
                <div class="test-title">
                    <span class="test-icon">üì¶</span>
                    <span class="test-status" id="sdkStatus"></span>
                    Supabase SDK
                </div>
                <div class="test-result" id="sdkResult">–û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞...</div>
            </div>

            <div class="test-card" id="authCard">
                <div class="test-title">
                    <span class="test-icon">üîê</span>
                    <span class="test-status" id="authStatus"></span>
                    –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                </div>
                <div class="test-result" id="authResult">–û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞...</div>
            </div>

            <div class="test-card" id="tablesCard">
                <div class="test-title">
                    <span class="test-icon">üóÑÔ∏è</span>
                    <span class="test-status" id="tablesStatus"></span>
                    –¢–∞–±–ª–∏—Ü—ã
                </div>
                <div class="test-result" id="tablesResult">–û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞...</div>
            </div>

            <div class="test-card" id="crudCard">
                <div class="test-title">
                    <span class="test-icon">‚úèÔ∏è</span>
                    <span class="test-status" id="crudStatus"></span>
                    CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
                </div>
                <div class="test-result" id="crudResult">–û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞...</div>
            </div>

            <div class="test-card" id="performanceCard">
                <div class="test-title">
                    <span class="test-icon">‚ö°</span>
                    <span class="test-status" id="performanceStatus"></span>
                    –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                </div>
                <div class="test-result" id="performanceResult">–û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞...</div>
            </div>
        </div>

        <div class="logs" id="logContainer"></div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const SUPABASE_CONFIG = {
            url: 'https://xqtokipsfzywippmvpgp.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxdG9raXBzZnp5d2lwcG12cGdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzEwNzAyNDQsImV4cCI6MjA0NjY0NjI0NH0.GgwhQgjWLrOj4zYoL6S7_3iuYdO4ufcRsAWY_wqtTkY'
        };

        let supabaseClient = null;
        let isTestingInProgress = false;

        // –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        const logger = {
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span>
                    <span class="log-${type}">${message}</span>
                `;
                document.getElementById('logContainer').appendChild(logEntry);
                document.getElementById('logContainer').scrollTop = document.getElementById('logContainer').scrollHeight;
                console.log(`[${timestamp}] ${message}`);
            },
            
            success(message) { this.log(`‚úÖ ${message}`, 'success'); },
            error(message) { this.log(`‚ùå ${message}`, 'error'); },
            warning(message) { this.log(`‚ö†Ô∏è ${message}`, 'warning'); },
            info(message) { this.log(`‚ÑπÔ∏è ${message}`, 'info'); }
        };

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–µ—Å—Ç–∞
        function updateTestStatus(testName, status, message) {
            const statusElement = document.getElementById(`${testName}Status`);
            const resultElement = document.getElementById(`${testName}Result`);
            const cardElement = document.getElementById(`${testName}Card`);

            statusElement.className = `test-status ${status}`;
            resultElement.textContent = message;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–∞—Ä—Ç–æ—á–∫–∏
            cardElement.className = `test-card ${status}`;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ Supabase SDK
        async function loadSupabaseSDK() {
            return new Promise((resolve, reject) => {
                if (window.supabase) {
                    resolve();
                    return;
                }

                logger.info('–ó–∞–≥—Ä—É–∑–∫–∞ Supabase SDK...');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                script.onload = () => {
                    logger.success('Supabase SDK –∑–∞–≥—Ä—É–∂–µ–Ω');
                    resolve();
                };
                script.onerror = () => {
                    logger.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Supabase SDK');
                    reject(new Error('Failed to load SDK'));
                };
                document.head.appendChild(script);
            });
        }

        // –¢–µ—Å—Ç —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function testNetworkConnection() {
            logger.info('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
            updateTestStatus('network', 'warning', '–ü—Ä–æ–≤–µ—Ä–∫–∞...');

            try {
                // –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                const response = await fetch('https://httpbin.org/get', { 
                    method: 'GET',
                    timeout: 5000 
                });

                if (response.ok) {
                    updateTestStatus('network', 'success', '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                    logger.success('–°–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ OK');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateTestStatus('network', 'error', `–û—à–∏–±–∫–∞: ${error.message}`);
                logger.error(`–°–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`);
                return false;
            }
        }

        // –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ SDK
        async function testSupabaseSDK() {
            logger.info('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Supabase SDK...');
            updateTestStatus('sdk', 'warning', '–ó–∞–≥—Ä—É–∑–∫–∞ SDK...');

            try {
                await loadSupabaseSDK();

                if (window.supabase) {
                    supabaseClient = window.supabase.createClient(
                        SUPABASE_CONFIG.url,
                        SUPABASE_CONFIG.anonKey,
                        {
                            auth: {
                                persistSession: false,
                                autoRefreshToken: false
                            }
                        }
                    );

                    updateTestStatus('sdk', 'success', 'SDK –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω');
                    logger.success('Supabase SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    return true;
                } else {
                    throw new Error('SDK –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                }
            } catch (error) {
                updateTestStatus('sdk', 'error', `–û—à–∏–±–∫–∞: ${error.message}`);
                logger.error(`Supabase SDK: ${error.message}`);
                return false;
            }
        }

        // –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        async function testAuthentication() {
            logger.info('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...');
            updateTestStatus('auth', 'warning', '–ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞...');

            try {
                if (!supabaseClient) {
                    throw new Error('–ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                }

                // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ API –∫–ª—é—á–∞
                const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                    }
                });

                if (response.ok) {
                    updateTestStatus('auth', 'success', 'API –∫–ª—é—á –≤–∞–ª–∏–¥–µ–Ω');
                    logger.success('–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                updateTestStatus('auth', 'error', `–û—à–∏–±–∫–∞: ${error.message}`);
                logger.error(`–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: ${error.message}`);
                return false;
            }
        }

        // –¢–µ—Å—Ç —Ç–∞–±–ª–∏—Ü
        async function testTables() {
            logger.info('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–∞–º...');
            updateTestStatus('tables', 'warning', '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü...');

            try {
                if (!supabaseClient) {
                    throw new Error('–ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                }

                const tables = ['tarot_user_profiles', 'tarot_questions', 'tarot_daily_cards'];
                const results = [];

                for (const table of tables) {
                    try {
                        const { data, error } = await supabaseClient
                            .from(table)
                            .select('count')
                            .limit(1);

                        if (error && error.code !== 'PGRST116') {
                            results.push(`${table}: ‚ùå ${error.message}`);
                        } else {
                            results.push(`${table}: ‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞`);
                        }
                    } catch (err) {
                        results.push(`${table}: ‚ùå ${err.message}`);
                    }
                }

                const hasErrors = results.some(r => r.includes('‚ùå'));
                
                if (hasErrors) {
                    updateTestStatus('tables', 'warning', results.join(', '));
                    logger.warning('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
                } else {
                    updateTestStatus('tables', 'success', `${tables.length} —Ç–∞–±–ª–∏—Ü –¥–æ—Å—Ç—É–ø–Ω—ã`);
                    logger.success('–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –¥–æ—Å—Ç—É–ø–Ω—ã');
                }

                return !hasErrors;
            } catch (error) {
                updateTestStatus('tables', 'error', `–û—à–∏–±–∫–∞: ${error.message}`);
                logger.error(`–¢–µ—Å—Ç —Ç–∞–±–ª–∏—Ü: ${error.message}`);
                return false;
            }
        }

        // –¢–µ—Å—Ç CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
        async function testCRUDOperations() {
            logger.info('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–π...');
            updateTestStatus('crud', 'warning', '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏/—á—Ç–µ–Ω–∏—è...');

            try {
                if (!supabaseClient) {
                    throw new Error('–ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                }

                const testId = `test_${Date.now()}`;
                
                // CREATE - —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å
                const { data: created, error: createError } = await supabaseClient
                    .from('tarot_user_profiles')
                    .insert([{
                        telegram_id: testId,
                        username: 'test_user',
                        is_premium: false,
                        questions_used: 0
                    }])
                    .select();

                if (createError) {
                    throw new Error(`Create failed: ${createError.message}`);
                }

                // READ - —á–∏—Ç–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—É—é –∑–∞–ø–∏—Å—å
                const { data: read, error: readError } = await supabaseClient
                    .from('tarot_user_profiles')
                    .select('*')
                    .eq('telegram_id', testId);

                if (readError) {
                    throw new Error(`Read failed: ${readError.message}`);
                }

                // DELETE - —É–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å
                const { error: deleteError } = await supabaseClient
                    .from('tarot_user_profiles')
                    .delete()
                    .eq('telegram_id', testId);

                if (deleteError) {
                    logger.warning(`Delete failed: ${deleteError.message}`);
                }

                updateTestStatus('crud', 'success', 'CREATE, READ, DELETE —Ä–∞–±–æ—Ç–∞—é—Ç');
                logger.success('CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                return true;

            } catch (error) {
                updateTestStatus('crud', 'error', `–û—à–∏–±–∫–∞: ${error.message}`);
                logger.error(`CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏: ${error.message}`);
                return false;
            }
        }

        // –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        async function testPerformance() {
            logger.info('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...');
            updateTestStatus('performance', 'warning', '–ò–∑–º–µ—Ä–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏...');

            try {
                if (!supabaseClient) {
                    throw new Error('–ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                }

                const startTime = performance.now();
                
                const { data, error } = await supabaseClient
                    .from('tarot_user_profiles')
                    .select('count')
                    .limit(10);

                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                let status = 'success';
                let message = `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${responseTime}ms`;

                if (responseTime > 2000) {
                    status = 'warning';
                    message += ' (–º–µ–¥–ª–µ–Ω–Ω–æ)';
                } else if (responseTime > 5000) {
                    status = 'error';
                    message += ' (–æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ)';
                } else {
                    message += ' (–±—ã—Å—Ç—Ä–æ)';
                }

                updateTestStatus('performance', status, message);
                logger.info(`–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${responseTime}ms`);
                return true;

            } catch (error) {
                updateTestStatus('performance', 'error', `–û—à–∏–±–∫–∞: ${error.message}`);
                logger.error(`–¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: ${error.message}`);
                return false;
            }
        }

        // –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
        async function runAllTests() {
            if (isTestingInProgress) return;

            isTestingInProgress = true;
            logger.info('=== –ó–ê–ü–£–°–ö –ü–û–õ–ù–û–ô –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===');

            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => btn.disabled = true);

            try {
                // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã
                const results = {
                    network: await testNetworkConnection(),
                    sdk: await testSupabaseSDK(),
                    auth: await testAuthentication(),
                    tables: await testTables(),
                    crud: await testCRUDOperations(),
                    performance: await testPerformance()
                };

                // –ü–æ–¥–≤–æ–¥–∏–º –∏—Ç–æ–≥–∏
                const passed = Object.values(results).filter(Boolean).length;
                const total = Object.keys(results).length;

                logger.info(`=== –†–ï–ó–£–õ–¨–¢–ê–¢: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ ===`);

                if (passed === total) {
                    logger.success('üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã! Supabase —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');
                } else if (passed >= total / 2) {
                    logger.warning('‚ö†Ô∏è –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã.');
                } else {
                    logger.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Supabase.');
                }

            } finally {
                // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ
                buttons.forEach(btn => btn.disabled = false);
                isTestingInProgress = false;
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        async function createTestData() {
            logger.info('–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');

            try {
                if (!supabaseClient) {
                    await testSupabaseSDK();
                }

                const testData = {
                    telegram_id: `demo_${Date.now()}`,
                    username: 'demo_user',
                    first_name: 'Demo',
                    is_premium: false,
                    questions_used: 1,
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabaseClient
                    .from('tarot_user_profiles')
                    .insert([testData])
                    .select();

                if (error) {
                    throw error;
                }

                logger.success(`–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã: ${data[0]?.telegram_id || 'ID –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}`);

            } catch (error) {
                logger.error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        function updateConfigDisplay() {
            document.getElementById('supabaseUrl').textContent = `URL: ${SUPABASE_CONFIG.url}`;
            document.getElementById('supabaseKey').textContent = `Key: ${SUPABASE_CONFIG.anonKey.substring(0, 20)}...`;
            document.getElementById('connectionMode').textContent = `–†–µ–∂–∏–º: ${supabaseClient ? '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω'}`;
        }

        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            logger.info('–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            updateConfigDisplay();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('runAllTests').addEventListener('click', runAllTests);
            document.getElementById('testBasicConnection').addEventListener('click', () => {
                testNetworkConnection();
                testSupabaseSDK();
                testAuthentication();
            });
            document.getElementById('testTables').addEventListener('click', testTables);
            document.getElementById('createTestData').addEventListener('click', createTestData);
            document.getElementById('clearLogs').addEventListener('click', clearLogs);

            logger.info('üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —É—Ç–∏–ª–∏—Ç–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
            logger.info('–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã" –¥–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏');
        });

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.SupabaseDiagnostic = {
            config: SUPABASE_CONFIG,
            client: () => supabaseClient,
            runAllTests,
            logger
        };
    </script>
</body>
</html>
