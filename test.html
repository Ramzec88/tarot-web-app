<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç Supabase - Tarot App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #51cf66, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .success-alert {
            background: rgba(81, 207, 102, 0.2);
            border: 2px solid #51cf66;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #4ecdc4;
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #4ecdc4;
            display: flex;
            align-items: center;
        }

        .section-icon {
            margin-right: 10px;
            font-size: 1.4rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .btn {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
            text-align: center;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }

        .btn.success {
            background: linear-gradient(135deg, #51cf66, #40c057);
        }

        .btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .btn.warning {
            background: linear-gradient(135deg, #ffd43b, #fab005);
            color: #1a1a2e;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 5px;
            color: #b0b0b0;
            font-weight: 500;
        }

        .input-field {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 14px;
        }

        .result-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            border-left: 4px solid #4ecdc4;
        }

        .result-panel.success {
            border-left-color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
        }

        .result-panel.error {
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-timestamp {
            color: #868e96;
            margin-right: 10px;
        }

        .log-success { color: #51cf66; }
        .log-error { color: #ff6b6b; }
        .log-warning { color: #ffd43b; }
        .log-info { color: #74c0fc; }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #51cf66);
            width: 0%;
            transition: width 0.5s ease;
        }

        .hidden { display: none; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç</h1>
            <p>–ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</p>
        </div>

        <div class="success-alert">
            <h3 style="color: #51cf66; margin-bottom: 10px;">üéâ –ü–æ–ª–∏—Ç–∏–∫–∏ RLS —Å–æ–∑–¥–∞–Ω—ã!</h3>
            <p>–û—à–∏–±–∫–∞ "already exists" –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã. –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä–∏–º –∏—Ö —Ä–∞–±–æ—Ç—É.</p>
        </div>

        <div class="test-section">
            <div class="section-title">
                <span class="section-icon">üîë</span>
                –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase
            </div>
            <div class="input-group">
                <label class="input-label">Supabase URL:</label>
                <input type="text" class="input-field" id="supabaseUrl" value="https://jjowuzqfnwcuulcknkxh.supabase.co" readonly>
            </div>
            <div class="input-group">
                <label class="input-label">Anon Key:</label>
                <input type="password" class="input-field" id="supabaseKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à anon key">
            </div>
        </div>

        <div class="test-section">
            <div class="section-title">
                <span class="section-icon">üß™</span>
                –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            </div>
            
            <div class="controls">
                <button class="btn" id="testUserCreation">üë§ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                <button class="btn" id="testDailyCard">üÉè –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—É –¥–Ω—è</button>
                <button class="btn" id="testQuestion">‚ùì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                <button class="btn" id="testReview">‚≠ê –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∑—ã–≤</button>
            </div>

            <div class="controls">
                <button class="btn success" id="runAllTests">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
                <button class="btn primary" id="viewData">üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <button class="btn warning" id="clearTestData">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç-–¥–∞–Ω–Ω—ã–µ</button>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="log-container" id="logContainer"></div>

        <div class="result-panel hidden" id="resultPanel">
            <h4 id="resultTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h4>
            <div id="resultContent"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let supabaseClient = null;
        let testUserId = null;

        // –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        const logger = {
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span>
                    <span class="log-${type}">${message}</span>
                `;
                document.getElementById('logContainer').appendChild(logEntry);
                document.getElementById('logContainer').scrollTop = document.getElementById('logContainer').scrollHeight;
            },
            
            success(message) { this.log(`‚úÖ ${message}`, 'success'); },
            error(message) { this.log(`‚ùå ${message}`, 'error'); },
            warning(message) { this.log(`‚ö†Ô∏è ${message}`, 'warning'); },
            info(message) { this.log(`‚ÑπÔ∏è ${message}`, 'info'); }
        };

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgress(percentage) {
            document.getElementById('progressFill').style.width = `${percentage}%`;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showResult(title, content, type = 'success') {
            const panel = document.getElementById('resultPanel');
            const titleEl = document.getElementById('resultTitle');
            const contentEl = document.getElementById('resultContent');

            panel.className = `result-panel ${type}`;
            panel.classList.remove('hidden');
            titleEl.textContent = title;
            contentEl.innerHTML = content;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        async function initSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;

            if (!key) {
                logger.error('–í–≤–µ–¥–∏—Ç–µ Anon Key');
                return false;
            }

            try {
                supabaseClient = window.supabase.createClient(url, key, {
                    auth: {
                        persistSession: false,
                        autoRefreshToken: false
                    }
                });

                // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                const { error } = await supabaseClient
                    .from('tarot_user_profiles')
                    .select('count')
                    .limit(1);

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                logger.success('Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω');
                return true;

            } catch (error) {
                logger.error(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
                return false;
            }
        }

        // –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function testUserCreation() {
            if (!supabaseClient && !await initSupabase()) return false;

            logger.info('–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            
            try {
                testUserId = `test_${Date.now()}`;
                
                const { data, error } = await supabaseClient
                    .from('tarot_user_profiles')
                    .insert([{
                        telegram_id: testUserId,
                        username: 'Test User',
                        is_subscribed: false,
                        questions_used: 0,
                        free_predictions_left: 3
                    }])
                    .select()
                    .single();

                if (error) {
                    logger.error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${error.message}`);
                    return false;
                }

                logger.success(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω —Å ID: ${data.id}`);
                return data;

            } catch (error) {
                logger.error(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
                return false;
            }
        }

        // –¢–µ—Å—Ç 2: –ö–∞—Ä—Ç–∞ –¥–Ω—è
        async function testDailyCard() {
            if (!testUserId) {
                logger.warning('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return false;
            }

            logger.info('–¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –¥–Ω—è...');

            try {
                const { data, error } = await supabaseClient
                    .from('tarot_daily_cards')
                    .insert([{
                        user_id: testUserId,
                        card_date: new Date().toISOString().split('T')[0],
                        card_data: {
                            name: '–ó–≤–µ–∑–¥–∞',
                            description: '–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –¥–Ω—è'
                        },
                        ai_prediction: '–¢–µ—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –¥–ª—è –∫–∞—Ä—Ç—ã –¥–Ω—è'
                    }])
                    .select()
                    .single();

                if (error) {
                    logger.error(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –¥–Ω—è: ${error.message}`);
                    return false;
                }

                logger.success(`–ö–∞—Ä—Ç–∞ –¥–Ω—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Å ID: ${data.id}`);
                return data;

            } catch (error) {
                logger.error(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
                return false;
            }
        }

        // –¢–µ—Å—Ç 3: –í–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç
        async function testQuestion() {
            if (!testUserId) {
                logger.warning('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return false;
            }

            logger.info('–¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞ –∏ –æ—Ç–≤–µ—Ç–∞...');

            try {
                // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ–ø—Ä–æ—Å
                const { data: question, error: questionError } = await supabaseClient
                    .from('tarot_questions')
                    .insert([{
                        user_id: testUserId,
                        question_text: '–¢–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'
                    }])
                    .select()
                    .single();

                if (questionError) {
                    logger.error(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞: ${questionError.message}`);
                    return false;
                }

                logger.success(`–í–æ–ø—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Å ID: ${question.id}`);

                // –ó–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
                const { data: answer, error: answerError } = await supabaseClient
                    .from('tarot_answers')
                    .insert([{
                        question_id: question.id,
                        card_id: 'test_card',
                        card_name: '–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞',
                        interpretation: '–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å',
                        cards_drawn: [{
                            name: '–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞',
                            description: '–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç—ã'
                        }],
                        ai_prediction: '–¢–µ—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ò–ò',
                        spread_type: 'single_card'
                    }])
                    .select()
                    .single();

                if (answerError) {
                    logger.error(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞: ${answerError.message}`);
                    return false;
                }

                logger.success(`–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Å ID: ${answer.id}`);
                return { question, answer };

            } catch (error) {
                logger.error(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
                return false;
            }
        }

        // –¢–µ—Å—Ç 4: –û—Ç–∑—ã–≤
        async function testReview() {
            if (!testUserId) {
                logger.warning('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return false;
            }

            logger.info('–¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞...');

            try {
                const { data, error } = await supabaseClient
                    .from('tarot_reviews')
                    .insert([{
                        user_id: testUserId,
                        rating: 5,
                        review_text: '–û—Ç–ª–∏—á–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –¢–∞—Ä–æ! –¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–∑—ã–≤.',
                        username: 'Test User',
                        is_approved: true
                    }])
                    .select()
                    .single();

                if (error) {
                    logger.error(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞: ${error.message}`);
                    return false;
                }

                logger.success(`–û—Ç–∑—ã–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Å ID: ${data.id}`);
                return data;

            } catch (error) {
                logger.error(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
                return false;
            }
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
        async function viewData() {
            if (!supabaseClient && !await initSupabase()) return false;

            logger.info('–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü...');

            try {
                const tables = [
                    { name: 'tarot_user_profiles', display: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏' },
                    { name: 'tarot_daily_cards', display: '–ö–∞—Ä—Ç—ã –¥–Ω—è' },
                    { name: 'tarot_questions', display: '–í–æ–ø—Ä–æ—Å—ã' },
                    { name: 'tarot_answers', display: '–û—Ç–≤–µ—Ç—ã' },
                    { name: 'tarot_reviews', display: '–û—Ç–∑—ã–≤—ã' }
                ];

                let resultHtml = '<h5>üìä –î–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö:</h5><br>';

                for (const table of tables) {
                    const { data, error } = await supabaseClient
                        .from(table.name)
                        .select('*')
                        .limit(5);

                    if (error) {
                        resultHtml += `<strong>${table.display}:</strong> –û—à–∏–±–∫–∞ - ${error.message}<br>`;
                    } else {
                        resultHtml += `<strong>${table.display}:</strong> ${data.length} –∑–∞–ø–∏—Å–µ–π<br>`;
                        
                        if (data.length > 0) {
                            resultHtml += `<small>–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å: ${JSON.stringify(data[0], null, 2).substring(0, 100)}...</small><br>`;
                        }
                    }
                    resultHtml += '<br>';
                }

                showResult('–î–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ', resultHtml, 'success');

            } catch (error) {
                logger.error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        async function clearTestData() {
            if (!supabaseClient) return;

            logger.info('–û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');

            try {
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å test_ –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
                const tables = ['tarot_reviews', 'tarot_answers', 'tarot_questions', 'tarot_daily_cards', 'tarot_user_profiles'];

                for (const table of tables) {
                    if (table === 'tarot_user_profiles') {
                        await supabaseClient
                            .from(table)
                            .delete()
                            .like('telegram_id', 'test_%');
                    } else if (table === 'tarot_answers') {
                        await supabaseClient
                            .from(table)
                            .delete()
                            .eq('card_id', 'test_card');
                    } else {
                        await supabaseClient
                            .from(table)
                            .delete()
                            .like('user_id', 'test_%');
                    }
                }

                logger.success('–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
                testUserId = null;

            } catch (error) {
                logger.error(`–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ${error.message}`);
            }
        }

        // –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
        async function runAllTests() {
            logger.info('üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤...');
            updateProgress(0);

            const tests = [
                { name: '–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', fn: testUserCreation },
                { name: '–ö–∞—Ä—Ç–∞ –¥–Ω—è', fn: testDailyCard },
                { name: '–í–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç', fn: testQuestion },
                { name: '–û—Ç–∑—ã–≤', fn: testReview }
            ];

            let successCount = 0;
            const results = [];

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                logger.info(`--- –¢–µ—Å—Ç ${i + 1}/4: ${test.name} ---`);

                try {
                    const result = await test.fn();
                    if (result) {
                        successCount++;
                        results.push({ name: test.name, success: true });
                    } else {
                        results.push({ name: test.name, success: false });
                    }
                } catch (error) {
                    logger.error(`–¢–µ—Å—Ç "${test.name}" –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π: ${error.message}`);
                    results.push({ name: test.name, success: false, error: error.message });
                }

                updateProgress(((i + 1) / tests.length) * 100);
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
            let resultHtml = `<strong>–†–µ–∑—É–ª—å—Ç–∞—Ç: ${successCount}/${tests.length} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ</strong><br><br>`;
            
            results.forEach(result => {
                const icon = result.success ? '‚úÖ' : '‚ùå';
                resultHtml += `${icon} ${result.name}<br>`;
            });

            if (successCount === tests.length) {
                resultHtml += '<br><strong style="color: #51cf66;">üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã! Supabase —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!</strong>';
                resultHtml += '<br><br>–¢–µ–ø–µ—Ä—å –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ.';
            } else {
                resultHtml += '<br><strong style="color: #ff6b6b;">‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏</strong>';
                resultHtml += '<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º.';
            }

            showResult('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', resultHtml, successCount === tests.length ? 'success' : 'error');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('testUserCreation').addEventListener('click', testUserCreation);
            document.getElementById('testDailyCard').addEventListener('click', testDailyCard);
            document.getElementById('testQuestion').addEventListener('click', testQuestion);
            document.getElementById('testReview').addEventListener('click', testReview);
            document.getElementById('runAllTests').addEventListener('click', runAllTests);
            document.getElementById('viewData').addEventListener('click', viewData);
            document.getElementById('clearTestData').addEventListener('click', clearTestData);

            logger.info('–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
            logger.info('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Supabase Anon Key –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã');
        });

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
        window.FinalTest = {
            runAllTests,
            viewData,
            clearTestData,
            testUserCreation,
            testDailyCard,
            testQuestion,
            testReview
        };
    </script>
</body>
</html>
